<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aquaculture App</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #131c31;
      --muted: #8aa0c5;
      --text: #e8eefc;
      --primary: #4f8cff;
      --accent: #22c55e;
      --danger: #ef4444;
      --border: #23304e;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { position:sticky; top:0; z-index:10; backdrop-filter: blur(6px); background: rgba(11,18,32,0.75); border-bottom:1px solid var(--border); }
    .container { max-width:1100px; margin:0 auto; padding:16px; }
    .row { display:grid; gap:12px; }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    @media (max-width:900px){ .grid-3{ grid-template-columns:1fr 1fr;} }
    @media (max-width:640px){ .grid-3, .grid-2{ grid-template-columns:1fr;} }

    .brand { display:flex; gap:10px; align-items:center; }
    .logo { width:36px; height:36px; border-radius:8px; background:linear-gradient(135deg, var(--primary), #22d3ee); box-shadow: 0 6px 20px rgba(79,140,255,.35); }
    h1 { font-size:20px; margin:0; letter-spacing:.2px; }

    .toolbar { display:flex; gap:8px; align-items:center; }
    select, input, button { background:#0f172a; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; }
    select:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,140,255,.25); }
    button { cursor:pointer; background: var(--primary); border-color: transparent; }
    button.ghost { background: transparent; border-color: var(--border); }
    button.success { background: var(--accent); }
    button.danger { background: var(--danger); }

    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .tab { padding:10px 14px; border:1px solid var(--border); border-radius:999px; cursor:pointer; user-select:none; opacity:.8; }
    .tab.active { background: var(--primary); border-color: transparent; opacity:1; }

    .card { background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 4px 30px rgba(0,0,0,.25); }
    .card h2 { margin:0 0 12px; font-size:18px; }
    .muted { color: var(--muted); font-size: 12px; }
    .row-inline { display:flex; flex-wrap:wrap; gap:10px; align-items:end; }
    .field { display:flex; flex-direction:column; gap:6px; min-width:140px; flex:1; }
    label { font-size:12px; color: var(--muted); }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid var(--border); }
    th { color: var(--muted); font-weight:600; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); }
    .up { color:#22c55e; }
    .down { color:#ef4444; }

    .lang-toggle { display:flex; gap:8px; padding:6px; background:#0f172a; border:1px solid var(--border); border-radius:12px; }
    .lang-toggle button { background:transparent; border:none; padding:8px 12px; border-radius:8px; }
    .lang-toggle button.active { background:var(--primary); }

    .divider { height:1px; background:var(--border); margin:14px 0; opacity:.8; }
    .hidden { display:none !important; }
    .footer { text-align:center; padding:24px; color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1 id="t_appTitle">Aquaculture App</h1>
          <div class="muted" id="t_subTitle">Prawns Price ‚Ä¢ Harvesting ‚Ä¢ Seeds</div>
        </div>
      </div>
      <div class="toolbar">
        <div class="lang-toggle" role="tablist">
          <button id="btnTel" class="active" data-lang="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
          <button id="btnEn" data-lang="en">English</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="price" id="t_tabPrice">ü¶ê Prices</div>
      <div class="tab" data-tab="harvest" id="t_tabHarvest">üöö Harvesting</div>
      <div class="tab" data-tab="seeds" id="t_tabSeeds">üå± Seeds</div>
    </div>

    <!-- PRICES -->
    <section class="card" id="tab-price">
      <h2 id="t_priceTitle">Prawns ‚Äì Count vs Price</h2>
      <div class="row-inline">
        <div class="field" style="max-width:220px;">
          <label id="t_districtLabel">District</label>
          <select id="priceDistrict">
            <option>Krishna</option>
            <option>Nellore</option>
            <option>Prakasam</option>
            <option>West Godavari</option>
          </select>
        </div>
        <div class="field" style="max-width:220px;">
          <label id="t_dateLabel">Date</label>
          <input id="priceDate" type="date"/>
        </div>
        <div class="field" style="max-width:280px;">
          <label id="t_searchLabel">Search Count</label>
          <input id="priceSearch" placeholder="e.g., 200c" />
        </div>
      </div>
      <div class="divider"></div>
      <div class="muted" id="priceMeta"></div>
      <div style="overflow:auto;">
        <table id="priceTable">
          <thead>
            <tr><th id="t_count">Count</th><th id="t_price">Price (‚Çπ)</th><th id="t_change">Change</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- HARVESTING -->
    <section class="card hidden" id="tab-harvest">
      <h2 id="t_harvestTitle">Harvesting & Transport</h2>
      <div class="row grid-2">
        <div class="card" style="background:#0f172a;">
          <h3 id="t_iceBooking">Ice Booking</h3>
          <div class="row-inline">
            <div class="field">
              <label id="t_unit">Unit</label>
              <select id="iceUnit">
                <option value="tons">Tons</option>
                <option value="cans">Cans</option>
              </select>
            </div>
            <div class="field">
              <label id="t_quantity">Quantity</label>
              <input id="iceQty" type="number" min="0" step="0.01" placeholder="0" />
            </div>
            <div class="field">
              <label id="t_pricePerTon">Price / Ton (‚Çπ)</label>
              <input id="iceRate" type="number" min="0" step="1" value="3000" />
            </div>
          </div>
          <div class="divider"></div>
          <div id="iceOut" class="muted"></div>
        </div>
        <div class="card" style="background:#0f172a;">
          <h3 id="t_vanBooking">Van Booking</h3>
          <div class="row-inline">
            <div class="field">
              <label id="t_vanType">Van Type</label>
              <select id="vanType">
                <option value="2">2T</option>
                <option value="5">5T</option>
                <option value="8">8T</option>
                <option value="10">10T</option>
              </select>
            </div>
            <div class="field">
              <label id="t_ratePerKm">Rate / km (‚Çπ)</label>
              <input id="vanRate" type="number" min="0" step="1" value="35" />
            </div>
            <div class="field">
              <label id="t_distance">Distance (km)</label>
              <input id="vanKm" type="number" min="0" step="1" placeholder="0" />
            </div>
          </div>
          <div class="divider"></div>
          <div id="vanOut" class="muted"></div>
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="btnHarvestWA" class="success">üì≤ <span id="t_bookNow">Book via WhatsApp</span></button>
      </div>
    </section>

    <!-- SEEDS -->
    <section class="card hidden" id="tab-seeds">
      <h2 id="t_seedsTitle">Seeds Booking</h2>
      <div class="row-inline">
        <div class="field">
          <label id="t_state">State</label>
          <select id="seedState">
            <option>Andhra Pradesh</option>
            <option>Tamil Nadu</option>
          </select>
        </div>
        <div class="field" id="districtWrap">
          <label id="t_district">District</label>
          <select id="seedDistrict"></select>
        </div>
        <div class="field" style="flex:2;">
          <label id="t_hatchery">Hatchery</label>
          <input id="hatcherySearch" placeholder="Search hatchery" />
          <select id="seedHatchery" size="6" style="margin-top:8px; width:100%;"></select>
        </div>
      </div>
      <div class="row-inline" style="margin-top:10px;">
        <div class="field">
          <label>PL</label>
          <input id="seedPL" value="Vannamei SPF PL" readonly />
        </div>
        <div class="field">
          <label id="t_pricePerK">Price / 1000 (‚Çπ)</label>
          <input id="seedPrice" type="number" readonly />
        </div>
        <div class="field">
          <label id="t_production">Production</label>
          <select id="seedBatch">
            <option>Batch 1</option>
            <option>Batch 2</option>
          </select>
        </div>
        <div class="field">
          <label id="t_qtyK">Quantity (√ó1000)</label>
          <input id="seedQty" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="field">
          <label id="t_bookingDate">Booking Date</label>
          <input id="seedDate" type="date" />
        </div>
      </div>
      <div class="divider"></div>
      <div id="seedAvail" class="muted"></div>
      <div id="seedSummary" class="muted" style="margin-top:8px;"></div>
      <div class="row" style="margin-top:12px;">
        <button id="btnSeedsWA" class="success">üì≤ <span id="t_bookNow2">Book via WhatsApp</span></button>
      </div>
    </section>

    <div class="footer">¬© <span id="year"></span> Aquaculture ‚Äî <span id="t_footer">Mobile-first responsive web app</span></div>
  </main>

  <script>
    // ---------- i18n ----------
    const i18n = {
      en: {
        appTitle: 'Aquaculture App', subTitle:'Prawns Price ‚Ä¢ Harvesting ‚Ä¢ Seeds',
        tabPrice:'ü¶ê Prices', tabHarvest:'üöö Harvesting', tabSeeds:'üå± Seeds',
        priceTitle:'Prawns ‚Äì Count vs Price', districtLabel:'District', dateLabel:'Date', searchLabel:'Search Count',
        count:'Count', price:'Price (‚Çπ)', change:'Change',
        harvestTitle:'Harvesting & Transport', iceBooking:'Ice Booking', unit:'Unit', quantity:'Quantity', pricePerTon:'Price / Ton (‚Çπ)', vanBooking:'Van Booking', vanType:'Van Type', ratePerKm:'Rate / km (‚Çπ)', distance:'Distance (km)', bookNow:'Book via WhatsApp',
        seedsTitle:'Seeds Booking', state:'State', district:'District', hatchery:'Hatchery', pricePerK:'Price / 1000 (‚Çπ)', production:'Production', qtyK:'Quantity (√ó1000)', bookingDate:'Booking Date', bookNow2:'Book via WhatsApp', footer:'Mobile-first responsive web app'
      },
      te: {
        appTitle: '‡∞Ü‡∞ï‡±ç‡∞µ‡∞æ‡∞ï‡∞≤‡±ç‡∞ö‡∞∞‡±ç ‡∞Ø‡∞æ‡∞™‡±ç', subTitle:'‡∞ö‡±á‡∞™‡∞≤ ‡∞ß‡∞∞ ‚Ä¢ ‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡∞ø‡∞Ç‡∞ó‡±ç ‚Ä¢ ‡∞∏‡±Ä‡∞°‡±ç‡∞∏‡±ç',
        tabPrice:'ü¶ê ‡∞ß‡∞∞‡∞≤‡±Å', tabHarvest:'üöö ‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡∞ø‡∞Ç‡∞ó‡±ç', tabSeeds:'üå± ‡∞∏‡±Ä‡∞°‡±ç‡∞∏‡±ç',
        priceTitle:'‡∞™‡±ç‡∞∞‡∞æ‡∞®‡±ç‡∞∏‡±ç ‚Äì ‡∞ï‡±å‡∞Ç‡∞ü‡±ç vs ‡∞ß‡∞∞', districtLabel:'‡∞ú‡∞ø‡∞≤‡±ç‡∞≤‡∞æ', dateLabel:'‡∞§‡±á‡∞¶‡±Ä', searchLabel:'‡∞ï‡±å‡∞Ç‡∞ü‡±ç ‡∞µ‡±Ü‡∞§‡±Å‡∞ï‡±Å',
        count:'‡∞ï‡±å‡∞Ç‡∞ü‡±ç', price:'‡∞ß‡∞∞ (‚Çπ)', change:'‡∞Æ‡∞æ‡∞∞‡±ç‡∞™‡±Å',
        harvestTitle:'‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡∞ø‡∞Ç‡∞ó‡±ç & ‡∞ü‡±ç‡∞∞‡∞æ‡∞®‡±ç‡∞∏‡±ç‚Äå‡∞™‡±ã‡∞∞‡±ç‡∞ü‡±ç', iceBooking:'‡∞ê‡∞∏‡±ç ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç', unit:'‡∞Ø‡±Ç‡∞®‡∞ø‡∞ü‡±ç', quantity:'‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç', pricePerTon:'‡∞ü‡∞®‡±ç‚Äå‡∞ï‡±Å ‡∞ß‡∞∞ (‚Çπ)', vanBooking:'‡∞µ‡∞æ‡∞®‡±ç ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç', vanType:'‡∞µ‡∞æ‡∞®‡±ç ‡∞ü‡±à‡∞™‡±Å', ratePerKm:'‡∞ï‡∞ø‡∞Æ‡±Ä‡∞ï‡∞ø ‡∞ß‡∞∞ (‚Çπ)', distance:'‡∞¶‡±Ç‡∞∞‡∞Ç (‡∞ï‡∞ø‡∞Æ‡±Ä)', bookNow:'‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞æ‡∞™‡±ç ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞¨‡±Å‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø',
        seedsTitle:'‡∞∏‡±Ä‡∞°‡±ç‡∞∏‡±ç ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç', state:'‡∞∞‡∞æ‡∞∑‡±ç‡∞ü‡±ç‡∞∞‡∞Ç', district:'‡∞ú‡∞ø‡∞≤‡±ç‡∞≤‡∞æ', hatchery:'‡∞π‡±ç‡∞Ø‡∞æ‡∞ö‡±ç‚Äå‡∞∞‡±Ä', pricePerK:'1000‡∞ï‡∞ø ‡∞ß‡∞∞ (‚Çπ)', production:'‡∞™‡±ç‡∞∞‡±ä‡∞°‡∞ï‡±ç‡∞∑‡∞®‡±ç', qtyK:'‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç (√ó1000)', bookingDate:'‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç ‡∞§‡±á‡∞¶‡±Ä', bookNow2:'‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞æ‡∞™‡±ç ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞¨‡±Å‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø', footer:'‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç-‡∞´‡∞∏‡±ç‡∞ü‡±Å ‡∞∞‡±Ü‡∞∏‡±ç‡∞™‡∞æ‡∞®‡±ç‡∞∏‡∞ø‡∞µ‡±ç ‡∞µ‡±Ü‡∞¨‡±ç ‡∞Ø‡∞æ‡∞™‡±ç'
      }
    }
    let lang = 'te';
    const T = key => i18n[lang][key] || key;
    function applyLang(){
      document.getElementById('t_appTitle').textContent = T('appTitle');
      document.getElementById('t_subTitle').textContent = T('subTitle');
      document.getElementById('t_tabPrice').textContent = T('tabPrice');
      document.getElementById('t_tabHarvest').textContent = T('tabHarvest');
      document.getElementById('t_tabSeeds').textContent = T('tabSeeds');
      document.getElementById('t_priceTitle').textContent = T('priceTitle');
      document.getElementById('t_districtLabel').textContent = T('districtLabel');
      document.getElementById('t_dateLabel').textContent = T('dateLabel');
      document.getElementById('t_searchLabel').textContent = T('searchLabel');
      document.getElementById('t_count').textContent = T('count');
      document.getElementById('t_price').textContent = T('price');
      document.getElementById('t_change').textContent = T('change');
      document.getElementById('t_harvestTitle').textContent = T('harvestTitle');
      document.getElementById('t_iceBooking').textContent = T('iceBooking');
      document.getElementById('t_unit').textContent = T('unit');
      document.getElementById('t_quantity').textContent = T('quantity');
      document.getElementById('t_pricePerTon').textContent = T('pricePerTon');
      document.getElementById('t_vanBooking').textContent = T('vanBooking');
      document.getElementById('t_vanType').textContent = T('vanType');
      document.getElementById('t_ratePerKm').textContent = T('ratePerKm');
      document.getElementById('t_distance').textContent = T('distance');
      document.getElementById('t_bookNow').textContent = T('bookNow');
      document.getElementById('t_seedsTitle').textContent = T('seedsTitle');
      document.getElementById('t_state').textContent = T('state');
      document.getElementById('t_district').textContent = T('district');
      document.getElementById('t_hatchery').textContent = T('hatchery');
      document.getElementById('t_pricePerK').textContent = T('pricePerK');
      document.getElementById('t_production').textContent = T('production');
      document.getElementById('t_qtyK').textContent = T('qtyK');
      document.getElementById('t_bookingDate').textContent = T('bookingDate');
      document.getElementById('t_bookNow2').textContent = T('bookNow2');
      document.getElementById('t_footer').textContent = T('footer');
    }

    document.getElementById('btnTel').onclick = () => { lang='te'; applyLang(); document.getElementById('btnTel').classList.add('active'); document.getElementById('btnEn').classList.remove('active'); };
    document.getElementById('btnEn').onclick = () => { lang='en'; applyLang(); document.getElementById('btnEn').classList.add('active'); document.getElementById('btnTel').classList.remove('active'); };

    // ---------- Tabs ----------
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const target = t.dataset.tab;
      document.querySelectorAll('main section.card').forEach(sec => sec.classList.add('hidden'));
      document.getElementById('tab-'+target).classList.remove('hidden');
    }));

    // ---------- Utils ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const headers = lines.shift().split(',').map(h=>h.trim());
      return lines.map(l => {
        const cells = l.split(',');
        const obj = {}; headers.forEach((h,i)=> obj[h] = (cells[i]||'').trim());
        return obj;
      });
    }
    function formatINR(n){ return new Intl.NumberFormat('en-IN').format(Number(n)||0); }
    function todayStr(){ return new Date().toISOString().slice(0,10); }

    // ---------- Prices ----------
    const priceTableBody = document.querySelector('#priceTable tbody');
    const priceMeta = document.getElementById('priceMeta');
    const searchInput = document.getElementById('priceSearch');

    async function loadRates(){
      try {
        const res = await fetch('rates.csv?ts=' + Date.now());
        const text = await res.text();
        const rows = parseCSV(text); // Expect columns: count, price
        const prevMap = JSON.parse(localStorage.getItem('prevRates')||'{}');
        const date = $('#priceDate').value || todayStr();
        localStorage.setItem('prevRates', JSON.stringify(Object.fromEntries(rows.map(r=>[r.count, Number(r.price)]))));

        renderRates(rows, prevMap);
        priceMeta.textContent = `${$('#priceDistrict').value} ‚Ä¢ ${date}`;
      } catch(e){
        priceMeta.textContent = 'Failed to load rates.csv';
      }
    }

    function renderRates(rows, prev){
      const q = searchInput.value.trim().toLowerCase();
      const filtered = rows.filter(r => !q || (r.count||'').toLowerCase().includes(q));
      priceTableBody.innerHTML = '';
      filtered.forEach(r => {
        const tr = document.createElement('tr');
        const change = (prev && r.count in prev) ? (Number(r.price)-Number(prev[r.count])) : 0;
        tr.innerHTML = `
          <td>${r.count}</td>
          <td>‚Çπ ${formatINR(r.price)}</td>
          <td>${ change===0 ? '<span class="chip">‚Äî</span>' : (change>0 ? `<span class="chip up">‚ñ≤ +${formatINR(change)}</span>` : `<span class="chip down">‚ñº ${formatINR(change)}</span>`) }</td>
        `;
        priceTableBody.appendChild(tr);
      });
    }

    $('#priceDistrict').addEventListener('change', loadRates);
    $('#priceDate').addEventListener('change', loadRates);
    searchInput.addEventListener('input', ()=> loadRates());

    // ---------- Harvest ----------
    const iceUnit = $('#iceUnit'), iceQty=$('#iceQty'), iceRate=$('#iceRate'), iceOut=$('#iceOut');
    const vanType=$('#vanType'), vanRate=$('#vanRate'), vanKm=$('#vanKm'), vanOut=$('#vanOut');

    function calcIce(){
      const unit = iceUnit.value; let qty = Number(iceQty.value)||0; const rate = Number(iceRate.value)||0;
      if(unit==='cans'){ qty = qty/20; } // approx: 20 cans ‚âà 1 ton
      const cost = qty*rate;
      iceOut.textContent = `Ice: ${formatINR(qty.toFixed(2))} tons √ó ‚Çπ${formatINR(rate)} = ‚Çπ${formatINR(cost.toFixed(0))}`;
      return { tons: qty, rate, cost };
    }
    function calcVan(){
      const t = Number(vanType.value)||0; const r = Number(vanRate.value)||0; const km = Number(vanKm.value)||0;
      const cost = r*km;
      vanOut.textContent = `Van: ${t}T @ ‚Çπ${formatINR(r)} /km √ó ${formatINR(km)} km = ‚Çπ${formatINR(cost)}`;
      return { t, r, km, cost };
    }
    [iceUnit, iceQty, iceRate].forEach(el=> el.addEventListener('input', calcIce));
    [vanType, vanRate, vanKm].forEach(el=> el.addEventListener('input', calcVan));

    $('#btnHarvestWA').addEventListener('click', ()=>{
      const a = calcIce(); const b = calcVan();
      const total = Math.round((a.cost||0) + (b.cost||0));
      const msg = `Harvest Booking\nIce: ${a.tons.toFixed(2)} tons @ ‚Çπ${a.rate}\nVan: ${b.t}T, ‚Çπ${b.r}/km, ${b.km} km\nTotal: ‚Çπ${total}`;
      const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
    });

    // ---------- Seeds ----------
    const seedState=$('#seedState'), seedDistrict=$('#seedDistrict'), seedHatchery=$('#seedHatchery');
    const hatcherySearch=$('#hatcherySearch');
    const seedPL=$('#seedPL'), seedPrice=$('#seedPrice'), seedBatch=$('#seedBatch');
    const seedQty=$('#seedQty'), seedDate=$('#seedDate');
    const seedAvail=$('#seedAvail'), seedSummary=$('#seedSummary');
    let seedsData = [];

    async function loadSeeds(){
      try{
        const res = await fetch('seeds.csv?ts='+Date.now());
        const text = await res.text();
        seedsData = parseCSV(text); // columns expected: state,district,hatchery,PL,price,available
        refreshSeedsUI();
      } catch(e){
        seedAvail.textContent = 'Failed to load seeds.csv';
      }
    }

    function refreshSeedsUI(){
      const state = seedState.value;
      const all = seedsData.filter(r => r.state===state);
      const dists = [...new Set(all.map(r=> r.district).filter(Boolean))].sort();
      if(state==='Andhra Pradesh'){
        $('#districtWrap').classList.remove('hidden');
        seedDistrict.innerHTML = dists.map(d=>`<option>${d}</option>`).join('');
      } else {
        $('#districtWrap').classList.add('hidden');
        seedDistrict.innerHTML = '';
      }
      populateHatcheries();
    }

    function populateHatcheries(){
      const state = seedState.value;
      const district = seedDistrict.value;
      const q = hatcherySearch.value.trim().toLowerCase();
      const list = seedsData.filter(r => r.state===state && (state!=='Andhra Pradesh' || r.district===district))
                            .filter(r => !q || (r.hatchery||'').toLowerCase().includes(q));
      seedHatchery.innerHTML = list.map(r => `<option data-price="${r.price}" data-avail="${r.available}" value="${r.hatchery}">${r.hatchery} ‚Äî ‚Çπ${r.price}</option>`).join('');
      updateSeedSelection();
    }

    function updateSeedSelection(){
      const opt = seedHatchery.options[seedHatchery.selectedIndex];
      if(!opt){ seedPrice.value=''; seedAvail.textContent=''; return; }
      seedPrice.value = opt.dataset.price || '';
      const from = new Date();
      const to = new Date(); to.setDate(to.getDate()+7);
      seedAvail.textContent = `Availability: ${from.toLocaleDateString()} ‚Üí ${to.toLocaleDateString()} (static 7 days)`;
      updateSeedSummary();
    }

    function updateSeedSummary(){
      const qtyK = Number(seedQty.value)||0; const priceK = Number(seedPrice.value)||0;
      // Bonus: If Quantity = 100 (1,00,000 PL), add 30,000 free
      const bonus = qtyK===100 ? 30000 : 0;
      const totalSeeds = qtyK*1000 + bonus;
      const amount = qtyK * priceK;
      seedSummary.textContent = `Bonus: ${formatINR(bonus)} pcs ‚Ä¢ Total Seeds: ${formatINR(totalSeeds)} pcs ‚Ä¢ Amount: ‚Çπ${formatINR(amount)}`;
      return { qtyK, priceK, bonus, totalSeeds, amount };
    }

    seedState.addEventListener('change', refreshSeedsUI);
    seedDistrict.addEventListener('change', populateHatcheries);
    hatcherySearch.addEventListener('input', populateHatcheries);
    seedHatchery.addEventListener('change', updateSeedSelection);
    [seedQty, seedPrice, seedBatch, seedDate].forEach(el=> el.addEventListener('input', updateSeedSummary));

    $('#btnSeedsWA').addEventListener('click', ()=>{
      const sel = seedHatchery.value; const d = seedDistrict.value || '-';
      const s = updateSeedSummary();
      const msg = `Seeds Booking\nState: ${seedState.value}\nDistrict: ${d}\nHatchery: ${sel}\nPL: ${seedPL.value}\nPrice/1000: ‚Çπ${s.priceK}\nQty: ${s.qtyK}k\nBonus: ${s.bonus}\nTotal Seeds: ${s.totalSeeds}\nTotal Amount: ‚Çπ${s.amount}\nBooking Date: ${seedDate.value||todayStr()}\nProduction: ${seedBatch.value}`;
      const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
    });

    // ---------- Init ----------
    document.getElementById('year').textContent = new Date().getFullYear();
    $('#priceDate').value = todayStr();
    $('#seedDate').value = todayStr();
    applyLang();
    loadRates();
    loadSeeds();
    calcIce();
    calcVan();
  </script>
</body>
</html>
