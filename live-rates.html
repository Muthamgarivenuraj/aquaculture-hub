<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title data-i18n="pageLive">Live Rates</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6f8fb;--text:#0b1220;--muted:#5f6b85;--border:#e5e7ef;--brand:#1e66f5}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial}
  .container{max-width:720px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .logo{font-weight:800;font-size:1.3rem}
  a.back{padding:8px 14px;border:1px solid var(--border);border-radius:10px;text-decoration:none;color:#0b1220}
  h2{margin:12px 0;display:flex;align-items:baseline;gap:8px;flex-wrap:wrap}
  #todayDate{font-size:.9rem;color:#5f6b85}

  select,input,textarea{width:100%;padding:13px;border:1px solid var(--border);border-radius:12px;font-size:1rem;font-weight:600;background:#fff}
  input[readonly]{background:#f9fbff}
  label{display:block;margin:6px 0 4px;color:#334155;font-weight:700}

  .card{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:12px}
  .pad{padding:14px}

  /* Tabs */
  .tabs{display:flex;gap:10px;margin:12px 0}
  .tab{flex:1;text-align:center;padding:10px;border:1px solid var(--border);border-radius:12px;cursor:pointer;font-weight:700;background:#fff}
  .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

  /* Prawns List */
  .head{display:grid;grid-template-columns:1fr 1fr;background:#eef3ff}
  .cell{padding:12px 14px;text-align:center;font-weight:700}
  .row{display:grid;grid-template-columns:1fr 1fr}
  .row:nth-child(odd){background:#fff}
  .row:nth-child(even){background:#f9fbff}
  .left{display:flex;align-items:center;gap:8px;justify-content:flex-start;color:#1e66f5}
  .right{display:flex;align-items:center;justify-content:flex-end;color:#059669;font-weight:800}
  @media(max-width:640px){
    .head{display:none}
    .row{grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border)}
  }

  /* arrows */
  .trend{display:inline-flex;gap:6px;align-items:center;font-weight:700}
  .up{color:#0ea75a;animation:blink-up 1s ease-in-out 2}
  .down{color:#e11d48;animation:blink-down 1s ease-in-out 2}
  @keyframes blink-up{0%,100%{opacity:1;transform:translateY(0)}50%{opacity:.3;transform:translateY(-2px)}}
  @keyframes blink-down{0%,100%{opacity:1;transform:translateY(0)}50%{opacity:.3;transform:translateY(2px)}}

  /* Harvest Calc */
  .h3{margin:10px 0;color:#1e66f5;font-size:1.05rem;font-weight:800}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kpi{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-top:1px dashed var(--border);font-weight:700}
  .total{font-size:1.1rem}
  .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--brand);background:var(--brand);color:#fff;font-weight:800;text-decoration:none;width:100%}
  .btn:disabled{opacity:.5;pointer-events:none}
  @media(max-width:640px){ .grid2{grid-template-columns:1fr} }

  footer{text-align:center;margin:18px 0;color:#5f6b85;font-size:.85rem}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo" data-i18n="pageLive">Live Rates</div>
    <a class="back" href="index.html" data-i18n="home">Home</a>
  </header>

  <h2>
    <span id="districtName">Nellore</span>
    <small id="todayDate"></small>
  </h2>

  <div class="card pad" style="margin-bottom:10px">
    <label data-i18n="district">Select District</label>
    <select id="districtSelect" data-i18n-placeholder="district">
      <option>Select District</option>
      <option>Nellore</option><option>West Godavari</option>
      <option>East Godavari</option><option>Krishna</option><option>Prakasam</option>
    </select>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="shrimp" data-i18n="shrimp">Prawns</div>
    <div class="tab" data-tab="harvest" data-i18n="harvest">Harvest</div>
  </div>

  <!-- Prawns List -->
  <div class="card" id="prawnsList">
    <div class="head">
      <div class="cell" id="col1" data-i18n="count">Count</div>
      <div class="cell" id="col2" data-i18n="price">Price</div>
    </div>
    <div id="list"></div>
  </div>

  <!-- Harvest Calculator (no list) -->
  <div class="card" id="harvestCalc" style="display:none">
    <div class="pad">
      <h3 class="h3" data-i18n="iceBooking">Ice Booking</h3>
      <div class="grid2">
        <div>
          <label data-i18n="unit">Unit</label>
          <select id="unit">
            <option value="ton" data-i18n="uTon" selected>Tons</option>
            <option value="can" data-i18n="uCan">Cans</option>
          </select>
        </div>
        <div>
          <label id="priceLabel">Price (₹/ton)</label>
          <select id="unitPrice"></select>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label data-i18n="qty">Quantity</label>
          <input id="qty" type="number" min="0" step="0.5" value="1" />
        </div>
        <div>
          <label data-i18n="km">Distance (km)</label>
          <input id="km" type="number" min="0" step="1" value="10" />
        </div>
      </div>

      <h3 class="h3" style="margin-top:16px" data-i18n="vanBooking">Van Booking</h3>
      <div class="grid2">
        <div>
          <label data-i18n="vehicle">Vehicle</label>
          <select id="vehicle">
            <option value="2">2 Ton Van — ₹100/km</option>
            <option value="5">5 Ton Van — ₹200/km</option>
            <option value="8">8 Ton Truck — ₹300/km</option>
            <option value="10">10 Ton Truck — ₹400/km</option>
          </select>
        </div>
        <div>
          <label data-i18n="rate">Rate (₹/km)</label>
          <input id="vehRate" type="number" value="100" readonly />
        </div>
      </div>

      <!-- Only Transport + Total -->
      <div class="kpi"><span data-i18n="transCost">Transport cost</span> <strong id="transCost">₹ 0</strong></div>
      <div class="kpi total"><span data-i18n="total">Total</span> <strong id="total">₹ 0</strong></div>

      <div style="margin-top:10px">
        <a id="bookBtn" class="btn" href="#" target="_blank" rel="noopener" data-i18n="book">Book</a>
      </div>
    </div>
  </div>

  <footer>© <span id="yr"></span> Aquaculture A–Z Hub</footer>
</div>

<script>
/* ---------- i18n ---------- */
const I18N = {
  en:{pageLive:"Live Rates",home:"Home",district:"Select District",
      shrimp:"Prawns",harvest:"Harvest",count:"Count",price:"Price",
      iceBooking:"Ice Booking",vanBooking:"Van Booking",
      unit:"Unit",uTon:"Tons",uCan:"Cans",qty:"Quantity",km:"Distance (km)",
      vehicle:"Vehicle",rate:"Rate (₹/km)",transCost:"Transport cost",total:"Total",book:"Book",
      priceTon:"Price (₹/ton)",priceCan:"Price (₹/can)"},
  te:{pageLive:"లైవ్ రేట్స్",home:"హోమ్",district:"జిల్లా ఎంచుకోండి",
      shrimp:"రొయ్యలు",harvest:"హార్వెస్ట్",count:"కౌంట్",price:"ధర",
      iceBooking:"ఐస్ బుకింగ్",vanBooking:"వాన్ బుకింగ్",
      unit:"యూనిట్",uTon:"టన్నులు",uCan:"క్యాన్స్",qty:"పరిమాణం",km:"దూరం (కిమీ)",
      vehicle:"వాహనం",rate:"రేట్ (₹/కిమీ)",transCost:"రవాణా ఖర్చు",total:"మొత్తం",book:"బుక్ చేయి",
      priceTon:"ధర (₹/టన్ను)",priceCan:"ధర (₹/క్యాన్)"}
};
function getLang(){ return localStorage.getItem('lang') || 'en'; }
function t(k){ return (I18N[getLang()]||{})[k] || k; }
function applyI18N(){
  document.querySelectorAll('[data-i18n]').forEach(el=> el.textContent = t(el.dataset.i18n));
  const sel = document.getElementById('districtSelect');
  if(sel && sel.options.length){ sel.options[0].textContent = t('district'); }
  document.getElementById('priceLabel').textContent =
    (unit.value==='ton') ? t('priceTon') : t('priceCan');
  document.title = t('pageLive');
  // refresh date with correct locale
  setTodayDate();
}

/* ---------- District ---------- */
const dSel=document.getElementById('districtSelect');
const saved=localStorage.getItem('district');
if(saved){ dSel.value=saved; document.getElementById('districtName').textContent=saved; }
dSel.addEventListener('change',e=>{
  localStorage.setItem('district',e.target.value);
  document.getElementById('districtName').textContent=e.target.value;
  render();
});
document.getElementById('yr').textContent=new Date().getFullYear();

/* ---------- Date next to district (locale-aware) ---------- */
function setTodayDate(){
  const lang = getLang() === 'te' ? 'te-IN' : 'en-IN';
  const s = new Date().toLocaleDateString(lang, {year:'numeric', month:'short', day:'numeric'});
  document.getElementById('todayDate').textContent = s;
}

/* ---------- Load rates.csv (shrimp only) ---------- */
const CSV_URL='rates.csv';
const RATES={shrimp:{}, __loaded:false};

async function loadCSV(){
  if(RATES.__loaded) return;
  try{
    const res=await fetch(CSV_URL,{cache:'no-store'});
    const text=await res.text();
    for(const line of text.split(/\r?\n/)){
      const clean=line.trim();
      if(!clean || clean.startsWith('type,')) continue;
      const parts=clean.split(',').map(s=>s.trim());
      if(parts.length<4) continue;
      const [type,district,key,priceStr]=parts;
      const price=parseFloat(priceStr);
      if(type!=='shrimp' || !district || !key || isNaN(price)) continue;
      if(!RATES.shrimp[district]) RATES.shrimp[district]={};
      RATES.shrimp[district][key]=price;
    }
    RATES.__loaded=true;
  }catch(e){ console.warn('Failed to load rates.csv',e); }
}

/* ---------- Arrows (yesterday vs today) ---------- */
function dateKey(d){return d.toISOString().slice(0,10)}
function todayKey(){return dateKey(new Date())}
function yesterdayKey(){const d=new Date(); d.setDate(d.getDate()-1); return dateKey(d)}
function storageKey(dst,day){return `lr_shrimp_${dst}_${day}`}
function trend(prev,curr){
  if(prev==null||isNaN(prev)||curr==null||isNaN(curr)) return '';
  if(curr>prev) return '<span class="trend up">▲</span>';
  if(curr<prev) return '<span class="trend down">▼</span>';
  return '';
}

/* ---------- Render tabs ---------- */
let activeTab='shrimp';
async function render(){
  applyI18N();
  const district = localStorage.getItem('district') || 'Nellore';

  if(activeTab==='shrimp'){
    document.getElementById('prawnsList').style.display='block';
    document.getElementById('harvestCalc').style.display='none';

    await loadCSV();
    const list=document.getElementById('list'); list.innerHTML='';
    const yKey=yesterdayKey(), tKey=todayKey();
    const prev = JSON.parse(localStorage.getItem(storageKey(district,yKey)) || '{}');
    const curr = {};
    for(let c=200;c>=30;c-=10){
      const price = (RATES.shrimp[district]||{})[String(c)];
      curr[c]=price??null;
      list.insertAdjacentHTML('beforeend', `
        <div class="row">
          <div class="cell left">${trend(prev[c], price)} ${c}c</div>
          <div class="cell right">${price!=null?`₹ ${price}`:'—'}</div>
        </div>
      `);
    }
    localStorage.setItem(storageKey(district,tKey), JSON.stringify(curr));
  } else {
    document.getElementById('prawnsList').style.display='none';
    document.getElementById('harvestCalc').style.display='block';
  }
}

/* ---------- Tabs ---------- */
document.querySelectorAll('.tab').forEach(tb=>{
  tb.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    tb.classList.add('active');
    activeTab = tb.dataset.tab;
    render();
  });
});

/* ---------- Harvest calculator ---------- */
const VEHICLES={
  "2":  {label:"2 Ton Van",  rate:100},
  "5":  {label:"5 Ton Van",  rate:200},
  "8":  {label:"8 Ton Truck",rate:300},
  "10": {label:"10 Ton Truck",rate:400}
};
const PRICES={ton:[1200,1500,2000], can:[120,140,160]};

const unit=document.getElementById('unit'),
      unitPrice=document.getElementById('unitPrice'),
      qty=document.getElementById('qty'),
      km=document.getElementById('km'),
      vehicle=document.getElementById('vehicle'),
      vehRate=document.getElementById('vehRate'),
      transCostEl=document.getElementById('transCost'),
      totalEl=document.getElementById('total'),
      bookBtn=document.getElementById('bookBtn');

function fillPriceOptions(){
  unitPrice.innerHTML="";
  (PRICES[unit.value]||[]).forEach((p,i)=>{
    const opt=document.createElement('option');
    opt.value=p; opt.textContent=`₹ ${p}`;
    if(i===0) opt.selected=true;
    unitPrice.appendChild(opt);
  });
  document.getElementById('priceLabel').textContent =
    (unit.value==='ton') ? t('priceTon') : t('priceCan');
}
function updateVehRate(){
  const v=VEHICLES[vehicle.value];
  vehRate.value=v ? v.rate : 0;
}
function recalc(){
  const price=parseFloat(unitPrice.value)||0;
  const q=parseFloat(qty.value)||0;
  const kms=parseFloat(km.value)||0;
  const rate=parseFloat(vehRate.value)||0;

  const harvestCost=Math.round(price*q);     // included in total (not shown)
  const transCost=Math.round(rate*kms);
  const total=harvestCost+transCost;

  transCostEl.textContent=`₹ ${transCost}`;
  totalEl.textContent=`₹ ${total}`;

  const district=localStorage.getItem('district')||'Nellore';
  const msg=[
    "Harvest Booking",
    `District: ${district}`,
    `Unit: ${unit.value==='ton'?t('uTon'):t('uCan')}`,
    `${(unit.value==='ton')?t('priceTon'):t('priceCan')}: ₹${price}`,
    `${t('qty')}: ${q}`,
    `${t('vehicle')}: ${VEHICLES[vehicle.value].label} (${rate}₹/km)`,
    `${t('km')}: ${kms}`,
    `${t('transCost')}: ₹${transCost}`,
    `${t('total')}: ₹${total}`
  ].join('\n');
  bookBtn.href=`https://wa.me/?text=${encodeURIComponent(msg)}`;
  bookBtn.disabled=total<=0;
}

/* events */
unit.addEventListener('change', ()=>{ fillPriceOptions(); applyI18N(); recalc(); });
unitPrice.addEventListener('change', recalc);
qty.addEventListener('input', recalc);
km.addEventListener('input', recalc);
vehicle.addEventListener('change', ()=>{ updateVehRate(); recalc(); });

/* init */
applyI18N();
setTodayDate();
fillPriceOptions();
updateVehRate();
recalc();
render();
</script>
</body>
</html>
