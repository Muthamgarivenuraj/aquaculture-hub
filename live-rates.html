<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title data-i18n="pageLive">Live Rates</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6f8fb;--text:#0b1220;--muted:#5f6b85;--border:#e5e7ef;--brand:#1e66f5}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial}
  .container{max-width:920px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .logo{font-weight:800;font-size:1.3rem}
  a.back{padding:8px 14px;border:1px solid var(--border);border-radius:10px;text-decoration:none;color:#0b1220}
  h2{margin:12px 0;display:flex;align-items:baseline;gap:8px;flex-wrap:wrap}
  #todayDate{font-size:.9rem;color:var(--muted)}

  select,input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:1rem;font-weight:600;background:#fff}
  input[readonly]{background:#f9fbff}
  label{display:block;margin:6px 0 4px;color:#334155;font-weight:700}

  .card{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:12px}
  .pad{padding:14px}

  /* Tabs: Prawns → Harvest → Seeds */
  .tabs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:12px 0}
  .tab{padding:10px;border:1px solid var(--border);border-radius:12px;cursor:pointer;font-weight:700;text-align:center;background:#fff}
  .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
  @media(max-width:640px){ .tabs{grid-template-columns:1fr 1fr} }

  /* Prawns two-col */
  .head2{display:grid;grid-template-columns:1fr 1fr;background:#eef3ff}
  .cell{padding:12px 14px;text-align:center;font-weight:700}
  .row2{display:grid;grid-template-columns:1fr 1fr}
  .row2:nth-child(odd){background:#fff}
  .row2:nth-child(even){background:#f9fbff}
  .left{display:flex;align-items:center;gap:8px;justify-content:flex-start;color:#1e66f5}
  .right{display:flex;align-items:center;justify-content:flex-end;color:#059669;font-weight:800}
  @media(max-width:640px){ .head2{display:none} .row2{grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border)} }
  .trend{display:inline-flex;gap:6px;align-items:center;font-weight:700}
  .up{color:#0ea75a;animation:blink-up 1s ease-in-out 2}
  .down{color:#e11d48;animation:blink-down 1s ease-in-out 2}
  @keyframes blink-up{0%,100%{opacity:1;transform:translateY(0)}50%{opacity:.3;transform:translateY(-2px)}}
  @keyframes blink-down{0%,100%{opacity:1;transform:translateY(0)}50%{opacity:.3;transform:translateY(2px)}}

  /* Seeds controls */
  .filters{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  @media(max-width:800px){ .filters{grid-template-columns:1fr} }
  .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:640px){ .info-grid{grid-template-columns:1fr} }

  .muted{color:var(--muted)}
  .h3{margin:10px 0;color:#1e66f5;font-size:1.05rem;font-weight:800}
  .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--brand);background:var(--brand);color:#fff;font-weight:800;text-decoration:none;width:100%}

  footer{text-align:center;margin:18px 0;color:var(--muted);font-size:.85rem}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo" data-i18n="pageLive">Live Rates</div>
    <a class="back" href="index.html" data-i18n="home">Home</a>
  </header>

  <h2>
    <span id="districtName">Nellore</span>
    <small id="todayDate"></small>
  </h2>

  <div class="card pad" style="margin-bottom:10px">
    <label data-i18n="district">Select District</label>
    <select id="districtSelect">
      <option>Select District</option>
      <option>Nellore</option><option>West Godavari</option>
      <option>East Godavari</option><option>Krishna</option><option>Prakasam</option>
    </select>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" data-tab="shrimp" data-i18n="prawnsPrice">Prawns – Price</div>
    <div class="tab" data-tab="harvest" data-i18n="harvesting">Harvesting</div>
    <div class="tab" data-tab="seeds" data-i18n="seeds">Seeds</div>
  </div>

  <!-- PRAWNS – PRICE -->
  <div class="card" id="prawnsList">
    <div class="head2"><div class="cell" data-i18n="count">Count</div><div class="cell" data-i18n="price">Price</div></div>
    <div id="list"></div>
  </div>

  <!-- HARVESTING -->
  <div class="card" id="harvestCalc" style="display:none">
    <div class="pad">
      <h3 class="h3" data-i18n="iceBooking">Ice Booking</h3>
      <div class="info-grid">
        <div><label data-i18n="unit">Unit</label>
          <select id="unit"><option value="ton" selected data-i18n="uTon">Tons</option><option value="can" data-i18n="uCan">Cans</option></select>
        </div>
        <div><label id="priceLabel">Price (₹/ton)</label><select id="unitPrice"></select></div>
      </div>
      <div class="info-grid" style="margin-top:10px">
        <div><label data-i18n="qty">Quantity</label><input id="qty" type="number" min="0" step="0.5" value="1" /></div>
        <div><label data-i18n="km">Distance (km)</label><input id="km" type="number" min="0" step="1" value="10" /></div>
      </div>
      <h3 class="h3" style="margin-top:16px" data-i18n="vanBooking">Van Booking</h3>
      <div class="info-grid">
        <div><label data-i18n="vehicle">Vehicle</label>
          <select id="vehicle">
            <option value="2">2 Ton Van — ₹100/km</option>
            <option value="5">5 Ton Van — ₹200/km</option>
            <option value="8">8 Ton Truck — ₹300/km</option>
            <option value="10">10 Ton Truck — ₹400/km</option>
          </select>
        </div>
        <div><label data-i18n="rate">Rate (₹/km)</label><input id="vehRate" type="number" value="100" readonly /></div>
      </div>
      <div class="info-grid" style="margin-top:10px">
        <div><label data-i18n="transCost">Transport cost</label><input id="transCost" value="₹ 0" readonly></div>
        <div><label data-i18n="total">Total</label><input id="total" value="₹ 0" readonly></div>
      </div>
      <div style="margin-top:10px"><a id="bookBtn" class="btn" href="#" target="_blank" rel="noopener" data-i18n="book">Book</a></div>
    </div>
  </div>

  <!-- SEEDS -->
  <div class="card" id="seedsSection" style="display:none">
    <div class="pad">
      <div class="filters">
        <div>
          <label data-i18n="state">State</label>
          <select id="seedState">
            <option>Andhra Pradesh</option>
            <option>Tamil Nadu</option>
          </select>
        </div>

        <div id="seedDistrictWrap">
          <label data-i18n="district">Select District</label>
          <select id="seedDistrict"><option value="">All Districts</option></select>
        </div>

        <div>
          <label data-i18n="hatchery">Hatchery</label>
          <select id="seedHatchery"><option value="">Select hatchery</option></select>
        </div>
      </div>
    </div>

    <div class="pad" style="border-top:1px solid var(--border)">
      <div class="info-grid">
        <div><label data-i18n="pl">Seeds PL</label><input id="staticPL" value="" readonly></div>
        <div><label data-i18n="pricePer1000">Price / 1000</label><input id="staticPrice" value="" readonly></div>
      </div>
      <div class="info-grid" style="margin-top:10px">
        <div><label data-i18n="availFrom">Available From</label><input id="staticFrom" value="" readonly></div>
        <div><label data-i18n="availTo">Available To</label><input id="staticTo" value="" readonly></div>
      </div>
      <div style="margin-top:10px"><a id="seedBookBtn" class="btn" href="#" target="_blank" rel="noopener" data-i18n="book">Book</a></div>
    </div>
  </div>

  <footer>© <span id="yr"></span> Aquaculture A–Z Hub</footer>
</div>

<script>
/* ===== i18n ===== */
const I18N={
  en:{pageLive:"Live Rates",home:"Home",district:"Select District",
      prawnsPrice:"Prawns – Price",harvesting:"Harvesting",seeds:"Seeds",
      count:"Count",price:"Price",pricePer1000:"Price / 1000",
      iceBooking:"Ice Booking",vanBooking:"Van Booking",
      unit:"Unit",uTon:"Tons",uCan:"Cans",qty:"Quantity",km:"Distance (km)",
      vehicle:"Vehicle",rate:"Rate (₹/km)",transCost:"Transport cost",total:"Total",book:"Book",
      priceTon:"Price (₹/ton)",priceCan:"Price (₹/can)",
      state:"State",hatchery:"Hatchery",pl:"Seeds PL",
      availFrom:"Available From",availTo:"Available To"},
  te:{pageLive:"లైవ్ రేట్స్",home:"హోమ్",district:"జిల్లా ఎంచుకోండి",
      prawnsPrice:"రొయ్యలు – ధర",harvesting:"హార్వెస్టింగ్",seeds:"సీడ్స్",
      count:"కౌంట్",price:"ధర",pricePer1000:"ధర / 1000",
      iceBooking:"ఐస్ బుకింగ్",vanBooking:"వాన్ బుకింగ్",
      unit:"యూనిట్",uTon:"టన్నులు",uCan:"క్యాన్స్",qty:"పరిమాణం",km:"దూరం (కిమీ)",
      vehicle:"వాహనం",rate:"రేట్ (₹/కిమీ)",transCost:"రవాణా ఖర్చు",total:"మొత్తం",book:"బుక్ చేయి",
      priceTon:"ధర (₹/టన్ను)",priceCan:"ధర (₹/క్యాన్)",
      state:"రాష్ట్రం",hatchery:"హ్యాచరీ",pl:"సీడ్స్ PL",
      availFrom:"అందుబాటులో నుండి",availTo:"వరకు"}
};
function lang(){return localStorage.getItem('lang')||'en';}
function t(k){return (I18N[lang()]||{})[k]||k;}
function applyI18N(){
  document.querySelectorAll('[data-i18n]').forEach(el=>el.textContent=t(el.dataset.i18n));
  const s=document.getElementById('districtSelect'); if(s&&s.options.length){ s.options[0].textContent=t('district'); }
  document.getElementById('priceLabel').textContent=(unit.value==='ton')?t('priceTon'):t('priceCan');
  document.getElementById('todayDate').textContent=new Date().toLocaleDateString(lang()==='te'?'te-IN':'en-IN',{year:'numeric',month:'short',day:'numeric'});
}

/* ===== header/date/district ===== */
document.getElementById('yr').textContent=new Date().getFullYear();
const dSel=document.getElementById('districtSelect');
const saved=localStorage.getItem('district');
if(saved){ dSel.value=saved; document.getElementById('districtName').textContent=saved; }
dSel.addEventListener('change',e=>{
  localStorage.setItem('district',e.target.value);
  document.getElementById('districtName').textContent=e.target.value;
  if(activeTab==='shrimp') renderPrawns();
});

/* ===== Tabs ===== */
let activeTab='shrimp';
const sections={shrimp:document.getElementById('prawnsList'),harvest:document.getElementById('harvestCalc'),seeds:document.getElementById('seedsSection')};
function showTab(name){
  activeTab=name;
  Object.entries(sections).forEach(([k,el])=>el.style.display=(k===name)?'block':'none');
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
  if(name==='shrimp') renderPrawns();
  if(name==='seeds') initSeeds();
}
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

/* ===== Prawns from CSV ===== */
const RATES={shrimp:{},loaded:false};
async function loadRates(){
  if(RATES.loaded) return;
  try{
    const text=await (await fetch('rates.csv',{cache:'no-store'})).text();
    text.split(/\r?\n/).forEach(line=>{
      const s=line.trim(); if(!s||s.startsWith('type,')) return;
      const [type,district,key,priceStr]=s.split(',').map(x=>x.trim());
      if(type!=='shrimp') return;
      (RATES.shrimp[district] ||= {})[key]=parseFloat(priceStr);
    });
    RATES.loaded=true;
  }catch(e){ console.warn('rates.csv missing'); }
}
function dateKey(d){return d.toISOString().slice(0,10)}
function todayKey(){return dateKey(new Date())}
function yesterdayKey(){const d=new Date(); d.setDate(d.getDate()-1); return dateKey(d)}
function storageKey(dst,day){return `lr_shrimp_${dst}_${day}`}
function trend(prev,curr){ if(prev==null||isNaN(prev)||curr==null||isNaN(curr)) return ''; if(curr>prev) return '<span class="trend up">▲</span>'; if(curr<prev) return '<span class="trend down">▼</span>'; return ''; }
async function renderPrawns(){
  await loadRates();
  const district=localStorage.getItem('district')||'Nellore';
  const yKey=yesterdayKey(), tKey=todayKey();
  const prev=JSON.parse(localStorage.getItem(storageKey(district,yKey))||'{}');
  const curr={};
  const list=document.getElementById('list'); list.innerHTML='';
  for(let c=200;c>=30;c-=10){
    const p=(RATES.shrimp[district]||{})[String(c)];
    curr[c]=p??null;
    list.insertAdjacentHTML('beforeend',`
      <div class="row2">
        <div class="cell left">${trend(prev[c],p)} ${c}c</div>
        <div class="cell right">${p!=null?`₹ ${p}`:'—'}</div>
      </div>`);
  }
  localStorage.setItem(storageKey(district,tKey), JSON.stringify(curr));
}

/* ===== Harvest calculator ===== */
const VEHICLES={"2":{label:"2 Ton Van",rate:100},"5":{label:"5 Ton Van",rate:200},"8":{label:"8 Ton Truck",rate:300},"10":{label:"10 Ton Truck",rate:400}};
const PRICES={ton:[1200,1500,2000], can:[120,140,160]};
const unit=document.getElementById('unit'),unitPrice=document.getElementById('unitPrice'),qty=document.getElementById('qty'),km=document.getElementById('km'),vehicle=document.getElementById('vehicle'),vehRate=document.getElementById('vehRate'),transCostEl=document.getElementById('transCost'),totalEl=document.getElementById('total'),bookBtn=document.getElementById('bookBtn');
function fillPriceOptions(){
  unitPrice.innerHTML="";
  (PRICES[unit.value]||[]).forEach((p,i)=>{const o=document.createElement('option');o.value=p;o.textContent=`₹ ${p}`;if(i===0)o.selected=true;unitPrice.appendChild(o);});
  document.getElementById('priceLabel').textContent=(unit.value==='ton')?t('priceTon'):t('priceCan');
}
function updateVehRate(){ vehRate.value=VEHICLES[vehicle.value].rate; }
function recalc(){
  const price=+unitPrice.value||0, q=+qty.value||0, kms=+km.value||0, rate=+vehRate.value||0;
  const harvestCost=Math.round(price*q), transCost=Math.round(rate*kms), total=harvestCost+transCost;
  transCostEl.value=`₹ ${transCost}`; totalEl.value=`₹ ${total}`;
  const district=localStorage.getItem('district')||'Nellore';
  const msg=[ "Harvest Booking", `District: ${district}`, `Unit: ${unit.value==='ton'?t('uTon'):t('uCan')}`,
              `${(unit.value==='ton')?t('priceTon'):t('priceCan')}: ₹${price}`, `${t('qty')}: ${q}`,
              `${t('vehicle')}: ${VEHICLES[vehicle.value].label} (${rate}₹/km)`, `${t('km')}: ${kms}`,
              `${t('transCost')}: ₹${transCost}`, `${t('total')}: ₹${total}` ].join('\n');
  bookBtn.href=`https://wa.me/?text=${encodeURIComponent(msg)}`; bookBtn.disabled=total<=0;
}
unit.addEventListener('change',()=>{fillPriceOptions();applyI18N();recalc();});
unitPrice.addEventListener('change',recalc); qty.addEventListener('input',recalc);
km.addEventListener('input',recalc); vehicle.addEventListener('change',()=>{updateVehRate();recalc();});
fillPriceOptions(); updateVehRate(); recalc();

/* ===== Seeds (names from CSV; static PL/Price; AP→District→Hatchery, TN→Hatchery only) ===== */
const SEED_STATIC = {
  pl: "Vannamei SPF PL",       // static PL
  price: 350,                  // static price per 1000
  from: (()=>{const d=new Date(); d.setDate(d.getDate()+1); return d.toISOString().slice(0,10);})(),
  to:   (()=>{const d=new Date(); d.setDate(d.getDate()+8); return d.toISOString().slice(0,10);})()
};

let SEEDS=[], SEEDS_LOADED=false, seedsInitDone=false;

async function loadSeeds(){
  if(SEEDS_LOADED) return;
  try{
    const text=await (await fetch('seeds.csv',{cache:'no-store'})).text();
    const rows=text.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
    const start=rows[0]?.toLowerCase().includes('state')?1:0;
    for(let i=start;i<rows.length;i++){
      const [state,district,hatchery]=rows[i].split(',').map(s=>s?.trim()||'');
      if(state && hatchery) SEEDS.push({state,district,hatchery});
    }
    SEEDS_LOADED=true;
  }catch(e){ console.warn('seeds.csv not found'); }
}

function fillDistricts(){
  const apDistricts = Array.from(new Set(SEEDS.filter(r=>r.state==='Andhra Pradesh' && r.district).map(r=>r.district))).sort((a,b)=>a.localeCompare(b));
  const dSel=document.getElementById('seedDistrict');
  dSel.innerHTML = `<option value="">All Districts</option>` + apDistricts.map(d=>`<option>${d}</option>`).join('');
}

function fillHatcheries(){
  const state=document.getElementById('seedState').value;
  const district=document.getElementById('seedDistrict').value;
  const hSel=document.getElementById('seedHatchery');
  let rows;
  if(state==='Tamil Nadu'){
    rows = SEEDS.filter(r=>r.state==='Tamil Nadu');
  }else{
    rows = SEEDS.filter(r=>r.state==='Andhra Pradesh' && (!district || r.district===district));
  }
  hSel.innerHTML = `<option value="">${t('hatchery')}</option>` +
    rows.map(r=>`<option data-state="${r.state}" data-district="${r.district||''}">${r.hatchery}</option>`).join('');
}

function applySeedsStatic(){
  document.getElementById('staticPL').value = SEED_STATIC.pl;
  document.getElementById('staticPrice').value = `₹ ${SEED_STATIC.price}`;
  document.getElementById('staticFrom').value = SEED_STATIC.from;
  document.getElementById('staticTo').value = SEED_STATIC.to;
}

function updateSeedsUI(){
  const wrap=document.getElementById('seedDistrictWrap');
  const state=document.getElementById('seedState').value;
  wrap.style.display = (state==='Tamil Nadu') ? 'none' : '';
  fillHatcheries();
  applySeedsStatic();
  updateSeedBookLink(); // even if no hatchery selected
}

function updateSeedBookLink(){
  const hSel=document.getElementById('seedHatchery');
  const opt=hSel.selectedOptions[0];
  const hatchName = opt ? opt.textContent : '';
  const state = opt ? opt.getAttribute('data-state') || document.getElementById('seedState').value : document.getElementById('seedState').value;
  const district = (state==='Andhra Pradesh') ? (opt?.getAttribute('data-district') || document.getElementById('seedDistrict').value || '') : '';
  const msg = [
    "Seeds Enquiry",
    `Hatchery: ${hatchName||'-'}`,
    `State: ${state}`,
    `District: ${district|| (localStorage.getItem('district')||'')}`,
    `Seeds PL: ${SEED_STATIC.pl}`,
    `Price / 1000: ₹${SEED_STATIC.price}`,
    `Available: ${SEED_STATIC.from} → ${SEED_STATIC.to}`
  ].join('\n');
  document.getElementById('seedBookBtn').href=`https://wa.me/?text=${encodeURIComponent(msg)}`;
}

/* Events */
document.getElementById('seedState').addEventListener('change', updateSeedsUI);
document.getElementById('seedDistrict').addEventListener('change', ()=>{ fillHatcheries(); updateSeedBookLink(); });
document.getElementById('seedHatchery').addEventListener('change', updateSeedBookLink);

/* Init seeds once */
async function initSeeds(){
  if(seedsInitDone){ updateSeedsUI(); return; }
  await loadSeeds();
  fillDistricts();
  updateSeedsUI();
  seedsInitDone=true;
}

/* ===== init page ===== */
applyI18N();
showTab('shrimp');       // default
renderPrawns();
initSeeds();             // preload
</script>
</body>
</html>
