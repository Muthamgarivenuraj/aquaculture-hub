<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Rates</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6f8fb;--text:#0b1220;--muted:#5f6b85;--border:#e5e7ef;--brand:#1e66f5}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial}
  .container{max-width:720px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .logo{font-weight:800;font-size:1.3rem}
  a.back{padding:8px 14px;border:1px solid var(--border);border-radius:10px;text-decoration:none;color:var(--text)}
  h2{margin:12px 0}
  label{display:block;margin:6px 0 4px;color:#334155;font-weight:700}
  select{width:100%;padding:13px;border:1px solid var(--border);border-radius:12px;font-size:1rem;font-weight:600;background:#fff}

  /* Tabs */
  .tabs{display:flex;gap:10px;margin:12px 0}
  .tab{flex:1;text-align:center;padding:10px;border:1px solid var(--border);border-radius:12px;cursor:pointer;font-weight:700;background:#fff}
  .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

  /* List card */
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden}
  .head{display:grid;grid-template-columns:1fr 1fr;background:#eef3ff}
  .cell{padding:12px 14px;text-align:center;font-weight:700}
  .row{display:grid;grid-template-columns:1fr 1fr}
  .row:nth-child(odd){background:#fff}
  .row:nth-child(even){background:#f9fbff}
  .left{display:flex;align-items:center;gap:8px;justify-content:flex-start;color:#1e66f5}
  .right{display:flex;align-items:center;justify-content:flex-end;color:#059669;font-weight:800}

  /* Mobile: keep 2 columns; count left, price right */
  @media(max-width:640px){
    .head{display:none}
    .row{grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border)}
    .left{justify-content:flex-start}
    .right{justify-content:flex-end}
  }

  /* arrows (only up/down) */
  .trend{display:inline-flex;gap:6px;align-items:center;font-weight:700}
  .up{color:#0ea75a;animation:blink-up 1s ease-in-out 2}
  .down{color:#e11d48;animation:blink-down 1s ease-in-out 2}
  @keyframes blink-up{0%,100%{opacity:1;transform:translateY(0)}50%{opacity:.3;transform:translateY(-2px)}}
  @keyframes blink-down{0%,100%{opacity:1;transform:translateY(0)}50%{opacity:.3;transform:translateY(2px)}}

  footer{text-align:center;margin:18px 0;color:var(--muted);font-size:.85rem}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo" data-i18n="pageLive">Live Rates</div>
    <a class="back" href="index.html" data-i18n="home">Home</a>
  </header>

  <h2 id="districtName">Nellore</h2>

  <div class="card" style="padding:12px;margin-bottom:10px">
    <label data-i18n="district">Select District</label>
    <select id="districtSelect" data-i18n-placeholder="district">
      <option>Select District</option>
      <option>Nellore</option><option>West Godavari</option>
      <option>East Godavari</option><option>Krishna</option><option>Prakasam</option>
    </select>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="shrimp" data-i18n="shrimp">Prawns</div>
    <div class="tab" data-tab="ice" data-i18n="ice">Ice</div>
  </div>

  <!-- Prices list -->
  <div class="card">
    <div class="head">
      <div class="cell" id="col1">Count</div>
      <div class="cell" id="col2">Price</div>
    </div>
    <div id="list"></div>
  </div>

  <footer>© <span id="yr"></span> Aquaculture A–Z Hub</footer>
</div>

<script>
/* i18n */
const I18N={
  en:{pageLive:"Live Rates",home:"Home",district:"Select District",
      shrimp:"Prawns",ice:"Ice",count:"Count",price:"Price",type:"Type"},
  te:{pageLive:"లైవ్ రేట్స్",home:"హోమ్",district:"జిల్లా ఎంచుకోండి",
      shrimp:"రొయ్యలు",ice:"ఐస్",count:"కౌంట్",price:"ధర",type:"రకం"}
};
function getLang(){return localStorage.getItem('lang')||'en';}
function t(k){return (I18N[getLang()]||{})[k]||k;}
function applyI18N(){
  document.querySelectorAll('[data-i18n]').forEach(el=>el.textContent=t(el.dataset.i18n));
  document.querySelectorAll('[data-i18n-placeholder]').forEach(sel=>{
    if(sel.options.length){sel.options[0].textContent=t(sel.getAttribute('data-i18n-placeholder'));}
  });
  document.getElementById('col1').textContent = activeTab==='shrimp'? t('count') : t('type');
  document.getElementById('col2').textContent = t('price');
}

/* District */
const dSel=document.getElementById('districtSelect');
const saved=localStorage.getItem('district'); if(saved){ dSel.value=saved; document.getElementById('districtName').textContent=saved; }
dSel.addEventListener('change',e=>{ localStorage.setItem('district',e.target.value); document.getElementById('districtName').textContent=e.target.value; render(); });
document.getElementById('yr').textContent=new Date().getFullYear();

/* Data from CSV */
const CSV_URL='rates.csv';
const RATES={shrimp:{},ice:{},__loaded:false};

async function loadCSV(){
  if(RATES.__loaded) return;
  const res=await fetch(CSV_URL,{cache:'no-store'}); const text=await res.text();
  for(const line of text.split(/\r?\n/)){
    const clean=line.trim(); if(!clean||clean.startsWith('type,')) continue;
    const parts=clean.split(',').map(s=>s.trim()); if(parts.length<4) continue;
    const [type,district,key,priceStr]=parts; const price=parseFloat(priceStr);
    if(!['shrimp','ice'].includes(type)||!district||!key||isNaN(price)) continue;
    if(!RATES[type][district]) RATES[type][district]={};
    RATES[type][district][key]=price;
  }
  RATES.__loaded=true;
}

/* Yesterday vs today storage for trend */
function dateKey(d){return d.toISOString().slice(0,10)}
function todayKey(){return dateKey(new Date())}
function yesterdayKey(){const d=new Date(); d.setDate(d.getDate()-1); return dateKey(d)}
function storageKey(tab,dst,day){return `lr_${tab}_${dst}_${day}`}

/* Only up/down arrow (no flat) */
function trend(prev,curr){
  if(prev==null||isNaN(prev)||curr==null||isNaN(curr)) return '';
  if(curr>prev) return '<span class="trend up">▲</span>';
  if(curr<prev) return '<span class="trend down">▼</span>';
  return '';
}

/* Render */
let activeTab='shrimp';

async function render(){
  const district = localStorage.getItem('district') || 'Nellore';
  applyI18N();
  await loadCSV();

  const list = document.getElementById('list');
  list.innerHTML='';

  const yKey=yesterdayKey(), tKey=todayKey();
  const prev = JSON.parse(localStorage.getItem(storageKey(activeTab,district,yKey)) || '{}');
  const curr = {};

  if(activeTab==='shrimp'){
    for(let c=200;c>=30;c-=10){
      const price = (RATES.shrimp[district]||{})[String(c)];
      curr[c]=price??null;
      list.insertAdjacentHTML('beforeend', `
        <div class="row">
          <div class="cell left">${trend(prev[c], price)} ${c}c</div>
          <div class="cell right">${price!=null?`₹ ${price}`:'—'}</div>
        </div>
      `);
    }
  } else {
    const items = Object.keys(RATES.ice[district]||{});
    if(items.length===0){ items.push('Block Ice 50kg'); }
    items.forEach(k=>{
      const price = (RATES.ice[district]||{})[k];
      curr[k]=price??null;
      list.insertAdjacentHTML('beforeend', `
        <div class="row">
          <div class="cell left">${trend(prev[k], price)} ${k}</div>
          <div class="cell right">${price!=null?`₹ ${price}`:'—'}</div>
        </div>
      `);
    });
  }

  localStorage.setItem(storageKey(activeTab,district,tKey), JSON.stringify(curr));
}

/* Tab clicks */
document.querySelectorAll('.tab').forEach(tb=>{
  tb.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    tb.classList.add('active');
    activeTab = tb.dataset.tab;
    render();
  });
});

/* Init */
render();
</script>
</body>
</html>
