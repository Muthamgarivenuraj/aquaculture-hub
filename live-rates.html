<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Rates ‚Ä¢ Aquaculture</title>
  <style>
    :root{
      --bg:#0b1220; --card:#131c31; --muted:#8aa0c5; --text:#e8eefc;
      --brand:#4f8cff; --ok:#22c55e; --bad:#ef4444; --line:#23304e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}

    /* Header (Only brand + Home) */
    header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),#22d3ee);box-shadow:0 6px 18px rgba(79,140,255,.35)}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted)}
    .home-btn{display:inline-block;padding:8px 12px;border-radius:10px;background:var(--brand);color:#fff;text-decoration:none;font-weight:700}

    /* Tabs + content */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{padding:10px 14px;border:1px solid var(--line);border-radius:999px;cursor:pointer;opacity:.9;background:#0f172a;color:var(--text)}
    .tab.active{background:var(--brand);border-color:transparent}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(0,0,0,.18)}
    .grid2{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:860px){.grid2{grid-template-columns:1fr 1fr}}
    .fields{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}
    .field{display:flex;flex-direction:column;gap:6px;min-width:180px;flex:1}
    label{color:var(--muted);font-size:12px}
    .select, input, button{background:#0f172a;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{color:var(--muted)}
    .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .divider{height:1px;background:var(--line);margin:12px 0;opacity:.8}
    .hidden{display:none!important}
    footer{text-align:center;color:var(--muted);padding:20px 0}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1 id="t_title">Live Rates</h1>
            <div class="muted" id="t_sub">Prawns ‚Ä¢ Harvest ‚Ä¢ Larvae</div>
          </div>
        </div>
        <!-- Only Home button on the right -->
        <a href="index.html" class="home-btn">üè† Home</a>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="prices" id="tab-prices" data-i18n="tabPrices">ü¶ê Prices</button>
        <button class="tab" data-tab="harvest" id="tab-harvest" data-i18n="tabHarvest">üöö Harvest</button>
        <button class="tab" data-tab="larvae" id="tab-larvae" data-i18n="tabLarvae">ü¶ê Larvae</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- PRICES -->
    <section id="panel-prices" class="card">
      <h3 id="t_priceTitle" style="margin:0 0 10px">Prawns ‚Äì Count vs Price</h3>
      <div class="fields">
        <div class="field" style="max-width:220px">
          <label id="t_district">District</label>
          <select id="priceDistrict" class="select">
            <option>Nellore</option><option>Krishna</option><option>Prakasam</option><option>West Godavari</option>
          </select>
        </div>
        <div class="field" style="max-width:220px">
          <label id="t_date">Date</label>
          <input id="priceDate" type="date" class="select">
        </div>
        <div class="field" style="flex:2;min-width:240px">
          <label id="t_search">Search Count</label>
          <input id="priceSearch" placeholder="e.g., 200c" class="select">
        </div>
      </div>
      <div class="divider"></div>
      <div class="muted" id="priceMeta"></div>
      <div style="overflow:auto;margin-top:8px">
        <table id="priceTable">
          <thead>
            <tr><th id="th_count">Count</th><th id="th_price">Price (‚Çπ)</th><th id="th_change">Change</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- HARVEST -->
    <section id="panel-harvest" class="card hidden">
      <h3 id="t_harvTitle" style="margin:0 0 10px">Harvesting & Transport</h3>
      <div class="grid2">
        <div class="card">
          <h4 id="t_ice">Ice Booking</h4>
          <div class="fields">
            <div class="field">
              <label id="t_unit">Unit</label>
              <select id="iceUnit" class="select">
                <option value="tons">Tons</option>
                <option value="cans">Cans</option>
              </select>
            </div>
            <div class="field">
              <label id="t_qty">Quantity</label>
              <input id="iceQty" type="number" min="0" step="0.01" class="select" placeholder="0">
            </div>
            <div class="field">
              <label id="t_rateTon">Price / Ton (‚Çπ)</label>
              <input id="iceRate" type="number" min="0" step="1" class="select" value="3000">
            </div>
          </div>
          <div class="divider"></div>
          <div id="iceOut" class="muted"></div>
        </div>

        <div class="card">
          <h4 id="t_van">Van Booking</h4>
          <div class="fields">
            <div class="field">
              <label id="t_vanType">Van Type</label>
              <select id="vanType" class="select">
                <option value="2">2T</option><option value="5">5T</option><option value="8">8T</option><option value="10">10T</option>
              </select>
            </div>
            <div class="field">
              <label id="t_rateKm">Rate / km (‚Çπ)</label>
              <input id="vanRate" type="number" min="0" step="1" class="select" value="35">
            </div>
            <div class="field">
              <label id="t_km">Distance (km)</label>
              <input id="vanKm" type="number" min="0" step="1" class="select" placeholder="0">
            </div>
          </div>
          <div class="divider"></div>
          <div id="vanOut" class="muted"></div>
        </div>
      </div>
      <div class="fields" style="margin-top:10px">
        <button id="btnHarvestWA">üì≤ <span id="t_book1">Book via WhatsApp</span></button>
      </div>
    </section>

    <!-- LARVAE -->
    <section id="panel-larvae" class="card hidden">
      <h3 id="t_seedTitle" style="margin:0 0 10px">Larvae Booking</h3>
      <div class="fields">
        <div class="field">
          <label id="t_state">State</label>
          <select id="seedState" class="select">
            <option>Andhra Pradesh</option><option>Tamil Nadu</option>
          </select>
        </div>
        <div class="field" id="districtWrap">
          <label id="t_district2">District</label>
          <select id="seedDistrict" class="select"></select>
        </div>
        <div class="field" style="flex:2;min-width:260px">
          <label id="t_hatchery">Hatchery</label>
          <input id="hatcherySearch" class="select" placeholder="Search hatchery">
          <select id="seedHatchery" size="6" class="select" style="margin-top:8px;height:160px"></select>
        </div>
      </div>

      <div class="fields" style="margin-top:10px">
        <div class="field">
          <label>PL</label>
          <input id="seedPL" class="select" value="Vannamei SPF PL" readonly>
        </div>
        <div class="field">
          <label id="t_priceK">Price / 1000 (‚Çπ)</label>
          <input id="seedPrice" class="select" readonly>
        </div>
        <div class="field">
          <label id="t_prod">Production</label>
          <select id="seedBatch" class="select"><option>Batch 1</option><option>Batch 2</option></select>
        </div>
        <div class="field">
          <label id="t_qtyK">Quantity (√ó1000)</label>
          <input id="seedQty" type="number" min="0" step="1" class="select" placeholder="0">
        </div>
        <div class="field">
          <label id="t_bookDate">Booking Date</label>
          <input id="seedDate" type="date" class="select">
        </div>
      </div>

      <div class="divider"></div>
      <div id="seedAvail" class="muted"></div>
      <div id="seedSummary" class="muted" style="margin-top:8px"></div>
      <div class="fields" style="margin-top:10px">
        <button id="btnSeedsWA">üì≤ <span id="t_book2">Book via WhatsApp</span></button>
      </div>
    </section>

    <footer>¬© <span id="yr"></span> Aquaculture ‚Äî Mobile-first</footer>
  </main>

  <script>
    // ---------- Language persistence from Home (no buttons here) ----------
    const I18N = {
      en:{ title:'Live Rates', sub:'Prawns ‚Ä¢ Harvest ‚Ä¢ Larvae',
        tabPrices:'ü¶ê Prices', tabHarvest:'üöö Harvest', tabLarvae:'ü¶ê Larvae',
        priceTitle:'Prawns ‚Äì Count vs Price', district:'District', date:'Date', search:'Search Count',
        th_count:'Count', th_price:'Price (‚Çπ)', th_change:'Change',
        harvTitle:'Harvesting & Transport', ice:'Ice Booking', unit:'Unit', qty:'Quantity', rateTon:'Price / Ton (‚Çπ)',
        van:'Van Booking', vanType:'Van Type', rateKm:'Rate / km (‚Çπ)', km:'Distance (km)', book1:'Book via WhatsApp',
        seedTitle:'Larvae Booking', state:'State', district2:'District', hatchery:'Hatchery', priceK:'Price / 1000 (‚Çπ)',
        prod:'Production', qtyK:'Quantity (√ó1000)', bookDate:'Booking Date', book2:'Book via WhatsApp'
      },
      te:{ title:'‡∞≤‡±à‡∞µ‡±ç ‡∞∞‡±á‡∞ü‡±ç‡∞∏‡±ç', sub:'‡∞™‡±ç‡∞∞‡∞æ‡∞®‡±ç‡∞∏‡±ç ‚Ä¢ ‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡±ç ‚Ä¢ ‡∞∞‡±ä‡∞Ø‡±ç‡∞Ø ‡∞™‡∞ø‡∞≤‡±ç‡∞≤‡∞≤‡±Å',
        tabPrices:'ü¶ê ‡∞ß‡∞∞‡∞≤‡±Å', tabHarvest:'üöö ‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡±ç', tabLarvae:'ü¶ê ‡∞∞‡±ä‡∞Ø‡±ç‡∞Ø ‡∞™‡∞ø‡∞≤‡±ç‡∞≤‡∞≤‡±Å',
        priceTitle:'‡∞™‡±ç‡∞∞‡∞æ‡∞®‡±ç‡∞∏‡±ç ‚Äì ‡∞ï‡±å‡∞Ç‡∞ü‡±ç vs ‡∞ß‡∞∞', district:'‡∞ú‡∞ø‡∞≤‡±ç‡∞≤‡∞æ', date:'‡∞§‡±á‡∞¶‡±Ä', search:'‡∞ï‡±å‡∞Ç‡∞ü‡±ç ‡∞µ‡±Ü‡∞§‡±Å‡∞ï‡±Å',
        th_count:'‡∞ï‡±å‡∞Ç‡∞ü‡±ç', th_price:'‡∞ß‡∞∞ (‚Çπ)', th_change:'‡∞Æ‡∞æ‡∞∞‡±ç‡∞™‡±Å',
        harvTitle:'‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡∞ø‡∞Ç‡∞ó‡±ç & ‡∞ü‡±ç‡∞∞‡∞æ‡∞®‡±ç‡∞∏‡±ç‚Äå‡∞™‡±ã‡∞∞‡±ç‡∞ü‡±ç', ice:'‡∞ê‡∞∏‡±ç ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç', unit:'‡∞Ø‡±Ç‡∞®‡∞ø‡∞ü‡±ç', qty:'‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç', rateTon:'‡∞ü‡∞®‡±ç‡∞®‡±Å‡∞ï‡±Å ‡∞ß‡∞∞ (‚Çπ)',
        van:'‡∞µ‡∞æ‡∞®‡±ç ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç', vanType:'‡∞µ‡∞æ‡∞®‡±ç ‡∞ü‡±à‡∞™‡±Å', rateKm:'‡∞ï‡∞ø‡∞Æ‡±Ä‡∞ï‡∞ø ‡∞ß‡∞∞ (‚Çπ)', km:'‡∞¶‡±Ç‡∞∞‡∞Ç (‡∞ï‡∞ø‡∞Æ‡±Ä)', book1:'‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞æ‡∞™‡±ç ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞¨‡±Å‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞ø',
        seedTitle:'‡∞∞‡±ä‡∞Ø‡±ç‡∞Ø ‡∞™‡∞ø‡∞≤‡±ç‡∞≤‡∞≤‡±Å ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç', state:'‡∞∞‡∞æ‡∞∑‡±ç‡∞ü‡±ç‡∞∞‡∞Ç', district2:'‡∞ú‡∞ø‡∞≤‡±ç‡∞≤‡∞æ', hatchery:'‡∞π‡±ç‡∞Ø‡∞æ‡∞ö‡∞∞‡±Ä', priceK:'1000‡∞ï‡∞ø ‡∞ß‡∞∞ (‚Çπ)',
        prod:'‡∞™‡±ç‡∞∞‡±ä‡∞°‡∞ï‡±ç‡∞∑‡∞®‡±ç', qtyK:'‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç (√ó1000)', bookDate:'‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç ‡∞§‡±á‡∞¶‡±Ä', book2:'‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞æ‡∞™‡±ç ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞¨‡±Å‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞ø'
      }
    };
    const getLang = ()=> localStorage.getItem('lang') || 'te';
    const T = k => (I18N[getLang()]||{})[k] || k;
    function applyLang(){
      document.documentElement.lang = getLang();
      const map = {
        t_title:'title', t_sub:'sub',
        tab-prices:'tabPrices', tab-harvest:'tabHarvest', tab-larvae:'tabLarvae',
        t_priceTitle:'priceTitle', t_district:'district', t_date:'date', t_search:'search',
        th_count:'th_count', th_price:'th_price', th_change:'th_change',
        t_harvTitle:'harvTitle', t_ice:'ice', t_unit:'unit', t_qty:'qty', t_rateTon:'rateTon',
        t_van:'van', t_vanType:'vanType', t_rateKm:'rateKm', t_km:'km', t_book1:'book1',
        t_seedTitle:'seedTitle', t_state:'state', t_district2:'district2', t_hatchery:'hatchery', t_priceK:'priceK',
        t_prod:'prod', t_qtyK:'qtyK', t_bookDate:'bookDate', t_book2:'book2'
      };
      // ids with hyphen need querySelector
      document.getElementById('t_title').textContent = T('title');
      document.getElementById('t_sub').textContent = T('sub');
      document.querySelector('#tab-prices').textContent = T('tabPrices');
      document.querySelector('#tab-harvest').textContent = T('tabHarvest');
      document.querySelector('#tab-larvae').textContent = T('tabLarvae');
      [
        ['t_priceTitle','priceTitle'],['t_district','district'],['t_date','date'],['t_search','search'],
        ['th_count','th_count'],['th_price','th_price'],['th_change','th_change'],
        ['t_harvTitle','harvTitle'],['t_ice','ice'],['t_unit','unit'],['t_qty','qty'],['t_rateTon','rateTon'],
        ['t_van','van'],['t_vanType','vanType'],['t_rateKm','rateKm'],['t_km','km'],['t_book1','book1'],
        ['t_seedTitle','seedTitle'],['t_state','state'],['t_district2','district2'],['t_hatchery','hatchery'],
        ['t_priceK','priceK'],['t_prod','prod'],['t_qtyK','qtyK'],['t_bookDate','bookDate'],['t_book2','book2']
      ].forEach(([id,key])=>{ const el=document.getElementById(id); if(el) el.textContent=T(key); });
    }

    // footer year
    document.getElementById('yr').textContent = new Date().getFullYear?.() || new Date().getFullYear();

    // Tabs + hash routing
    const tabs = document.querySelectorAll('.tab');
    function showTab(name){
      document.querySelectorAll('main > section.card').forEach(s=> s.classList.add('hidden'));
      document.getElementById('panel-'+name).classList.remove('hidden');
      tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab===name));
    }
    tabs.forEach(t=> t.addEventListener('click', ()=> showTab(t.dataset.tab)));
    const hash = (location.hash||'').replace('#','');
    if(['prices','harvest','larvae'].includes(hash)) showTab(hash);

    // CSV helpers
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const headers = lines.shift().split(',').map(h=>h.trim());
      return lines.map(l=>{
        const cells = l.split(',');
        const o={}; headers.forEach((h,i)=> o[h]= (cells[i]||'').trim());
        return o;
      });
    }
    const fmt = n => new Intl.NumberFormat('en-IN').format(Number(n)||0);
    const todayISO = () => new Date().toISOString().slice(0,10);

    // Prices
    const priceTableBody = document.querySelector('#priceTable tbody');
    const priceMeta = document.getElementById('priceMeta');
    const searchInput = document.getElementById('priceSearch');
    async function loadRates(){
      try{
        const res = await fetch('rates.csv?ts='+Date.now());
        const text = await res.text();
        const rows = parseCSV(text); // must have headers: count,price
        const prevMap = JSON.parse(localStorage.getItem('prevRates')||'{}');
        localStorage.setItem('prevRates', JSON.stringify(Object.fromEntries(rows.map(r=>[r.count, Number(r.price)]))));
        renderRates(rows, prevMap);
        priceMeta.textContent = `${document.getElementById('priceDistrict').value} ‚Ä¢ ${document.getElementById('priceDate').value||todayISO()}`;
      }catch(e){ priceMeta.textContent = 'Failed to load rates.csv'; }
    }
    function renderRates(rows, prev){
      const q = (searchInput.value||'').trim().toLowerCase();
      const filtered = rows.filter(r=> !q || (r.count||'').toLowerCase().includes(q));
      priceTableBody.innerHTML='';
      filtered.forEach(r=>{
        const change = (prev && r.count in prev) ? (Number(r.price)-Number(prev[r.count])) : 0;
        const mark = change===0 ? '<span class="chip">‚Äî</span>' : (change>0 ? `<span class="chip ok">‚ñ≤ +${fmt(change)}</span>` : `<span class="chip bad">‚ñº ${fmt(change)}</span>`);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.count||'-'}</td><td>‚Çπ ${fmt(r.price)}</td><td>${mark}</td>`;
        priceTableBody.appendChild(tr);
      });
    }
    document.getElementById('priceDistrict').addEventListener('change', loadRates);
    document.getElementById('priceDate').addEventListener('change', loadRates);
    searchInput.addEventListener('input', loadRates);

    // Harvest
    const iceUnit = document.getElementById('iceUnit'), iceQty = document.getElementById('iceQty'),
          iceRate = document.getElementById('iceRate'), iceOut = document.getElementById('iceOut');
    const vanType = document.getElementById('vanType'), vanRate = document.getElementById('vanRate'),
          vanKm = document.getElementById('vanKm'), vanOut = document.getElementById('vanOut');
    function calcIce(){ const unit=iceUnit.value; let qty=Number(iceQty.value)||0; const rate=Number(iceRate.value)||0;
      if(unit==='cans'){ qty = qty/20; } const cost=qty*rate;
      iceOut.textContent = `Ice: ${qty.toFixed(2)} tons √ó ‚Çπ${fmt(rate)} = ‚Çπ${fmt(cost)}`; return {tons:qty, rate, cost}; }
    function calcVan(){ const t=Number(vanType.value)||0, r=Number(vanRate.value)||0, km=Number(vanKm.value)||0;
      const cost=r*km; vanOut.textContent = `Van: ${t}T @ ‚Çπ${fmt(r)}/km √ó ${fmt(km)} km = ‚Çπ${fmt(cost)}`; return {t,r,km,cost}; }
    [iceUnit,iceQty,iceRate].forEach(el=> el.addEventListener('input', calcIce));
    [vanType,vanRate,vanKm].forEach(el=> el.addEventListener('input', calcVan));
    document.getElementById('btnHarvestWA').addEventListener('click', ()=>{
      const a = calcIce(); const b = calcVan(); const total = Math.round((a.cost||0)+(b.cost||0));
      const title = getLang()==='te' ? '*‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡±ç ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç*' : '*Harvest Booking*';
      const msg = [title,`Ice: ${a.tons.toFixed(2)} tons @ ‚Çπ${a.rate}`,`Van: ${b.t}T, ‚Çπ${b.r}/km, ${b.km} km`,`Total: ‚Çπ${total}`].join('\n');
      window.open('https://wa.me/?text='+encodeURIComponent(msg), '_blank');
    });

    // Larvae
    const seedState = document.getElementById('seedState'), seedDistrict = document.getElementById('seedDistrict'),
          seedHatchery = document.getElementById('seedHatchery'), hatcherySearch = document.getElementById('hatcherySearch'),
          seedPL = document.getElementById('seedPL'), seedPrice = document.getElementById('seedPrice'),
          seedBatch = document.getElementById('seedBatch'), seedQty = document.getElementById('seedQty'),
          seedDate = document.getElementById('seedDate'), seedAvail = document.getElementById('seedAvail'),
          seedSummary = document.getElementById('seedSummary');
    let seedsData = [];
    async function loadSeeds(){
      try{
        const res = await fetch('seeds.csv?ts='+Date.now());
        const text = await res.text();
        seedsData = parseCSV(text); // headers: state,district,hatchery,PL,price,available
        refreshSeedsUI();
      }catch(e){ seedAvail.textContent = 'Failed to load seeds.csv'; }
    }
    function refreshSeedsUI(){
      const state = seedState.value;
      const all = seedsData.filter(r=> r.state===state);
      const dists = [...new Set(all.map(r=>r.district).filter(Boolean))].sort();
      if(state==='Andhra Pradesh'){
        document.getElementById('districtWrap').classList.remove('hidden');
        seedDistrict.innerHTML = dists.map(d=>`<option>${d}</option>`).join('');
      }else{
        document.getElementById('districtWrap').classList.add('hidden');
        seedDistrict.innerHTML = '';
      }
      populateHatcheries();
    }
    function populateHatcheries(){
      const state = seedState.value; const district = seedDistrict.value; const q=(hatcherySearch.value||'').toLowerCase();
      let list = seedsData.filter(r=> r.state===state && (state!=='Andhra Pradesh' || r.district===district));
      if(q) list = list.filter(r=> (r.hatchery||'').toLowerCase().includes(q));
      seedHatchery.innerHTML = list.map(r=> `<option value="${r.hatchery}" data-price="${r.price}" data-avail="${r.available||''}">${r.hatchery} ‚Äî ‚Çπ${r.price}</option>`).join('');
      updateSeedSelection();
    }
    function updateSeedSelection(){
      const opt = seedHatchery.options[seedHatchery.selectedIndex];
      if(!opt){ seedPrice.value=''; seedAvail.textContent=''; return; }
      seedPrice.value = opt.dataset.price || '';
      const from = new Date(), to = new Date(); to.setDate(to.getDate()+7);
      seedAvail.textContent = `${getLang()==='te'?'‡∞Ö‡∞µ‡±à‡∞≤‡∞¨‡∞ø‡∞≤‡∞ø‡∞ü‡±Ä':'Availability'}: ${from.toLocaleDateString()} ‚Üí ${to.toLocaleDateString()} (7 days)`;
      updateSeedSummary();
    }
    function updateSeedSummary(){
      const qtyK = Number(seedQty.value)||0; const priceK = Number(seedPrice.value)||0;
      const bonus = qtyK===100 ? 30000 : 0; // 1,00,000 larvae ‚Üí +30,000
      const totalSeeds = qtyK*1000 + bonus;
      const amount = qtyK * priceK;
      const bonusLabel = getLang()==='te'?'‡∞¨‡±ã‡∞®‡∞∏‡±ç':'Bonus';
      const totalL = getLang()==='te'?'‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞™‡∞ø‡∞≤‡±ç‡∞≤‡∞≤‡±Å':'Total Larvae';
      const amtLabel = getLang()==='te'?'‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞Ö‡∞Æ‡±å‡∞Ç‡∞ü‡±ç':'Total Amount';
      seedSummary.textContent = `${bonusLabel}: ${fmt(bonus)} ‚Ä¢ ${totalL}: ${fmt(totalSeeds)} ‚Ä¢ ${amtLabel}: ‚Çπ${fmt(amount)}`;
      return { qtyK, priceK, bonus, totalSeeds, amount };
    }
    seedState.addEventListener('change', refreshSeedsUI);
    seedDistrict.addEventListener('change', populateHatcheries);
    hatcherySearch.addEventListener('input', populateHatcheries);
    seedHatchery.addEventListener('change', updateSeedSelection);
    [seedQty, seedBatch, seedDate].forEach(el=> el.addEventListener('input', updateSeedSummary));
    document.getElementById('btnSeedsWA').addEventListener('click', ()=>{
      const sel = seedHatchery.value || '-'; const d = seedDistrict.value || '-'; const s = updateSeedSummary();
      const title = getLang()==='te' ? '*‡∞∞‡±ä‡∞Ø‡±ç‡∞Ø ‡∞™‡∞ø‡∞≤‡±ç‡∞≤‡∞≤‡±Å ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç*' : '*Larvae Booking*';
      const lines = [title,`State: ${seedState.value}`, seedState.value==='Andhra Pradesh' ? `District: ${d}` : '',
        `Hatchery: ${sel}`, `PL: ${seedPL.value}`, `Price/1000: ‚Çπ${s.priceK}`, `Qty: ${s.qtyK}k`,
        `Bonus: ${s.bonus}`, `Total Larvae: ${s.totalSeeds}`, `Total Amount: ‚Çπ${s.amount}`,
        `Booking Date: ${seedDate.value || todayISO()}`, `Production: ${seedBatch.value}`].filter(Boolean).join('\n');
      window.open('https://wa.me/?text='+encodeURIComponent(lines), '_blank');
    });

    // Init
    document.getElementById('priceDate').value = todayISO();
    document.getElementById('seedDate').value = todayISO();
    applyLang();
    loadRates(); loadSeeds(); calcIce(); calcVan();
  </script>
</body>
</html>
