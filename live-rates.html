<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Rates</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f6f8fb;--text:#0b1220;--muted:#5f6b85;--border:#e5e7ef;--brand:#1e66f5;--up:#0ea75a;--down:#e11d48}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial}
    .container{max-width:720px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .logo{font-weight:800;font-size:1.3rem}
    a.back{padding:8px 14px;border:1px solid var(--border);border-radius:10px;text-decoration:none;color:var(--text)}
    h2{margin:12px 0}
    select{width:100%;padding:14px;border:1px solid var(--border);border-radius:12px;font-size:1rem;font-weight:600;margin-bottom:16px}
    .tabs{display:flex;gap:10px;margin-bottom:12px}
    .tab{flex:1;text-align:center;padding:10px;border:1px solid var(--border);border-radius:12px;cursor:pointer;font-weight:600;background:#fff}
    .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

    .section{border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-top:10px;background:#fff}
    .section .head{display:grid;grid-template-columns:1fr 1fr;background:#eef3ff}
    .row{display:grid;grid-template-columns:1fr 1fr}
    .cell{padding:12px 14px;text-align:center;font-weight:600}
    .row:nth-child(odd){background:#fff}
    .row:nth-child(even){background:#f9fbff}
    .count{color:#1e66f5;display:flex;gap:8px;align-items:center;justify-content:center}
    .price{color:#059669;font-weight:800}

    .subttl{margin-top:16px;font-weight:800}

    footer{text-align:center;margin:20px 0;color:var(--muted);font-size:.85rem}

    @media(max-width:600px){
      .section .head{display:none}
      .row{grid-template-columns:1fr;border-bottom:1px solid var(--border)}
      .cell{display:flex;justify-content:space-between}
      .count{justify-content:space-between}
    }

    /* 🔄 Blink Animations for trend arrows */
    @keyframes blink-up { 0%,100% {opacity:1; transform:translateY(0);} 50% {opacity:0.3; transform:translateY(-2px);} }
    @keyframes blink-down { 0%,100% {opacity:1; transform:translateY(0);} 50% {opacity:0.3; transform:translateY(2px);} }
    .trend{display:inline-flex;gap:6px;align-items:center;justify-content:center;font-weight:700}
    .trend.up {color:var(--up); animation:blink-up 1s ease-in-out 2;}
    .trend.down {color:var(--down); animation:blink-down 1s ease-in-out 2;}
    .trend.flat {color:var(--muted);}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" data-i18n="pageLive">Live Rates</div>
      <a class="back" href="index.html" data-i18n="home">Home</a>
    </header>

    <h2 id="districtName">Nellore</h2>

    <select id="districtSelect" data-i18n-placeholder="district">
      <option>Select District</option>
      <option>Nellore</option><option>West Godavari</option>
      <option>East Godavari</option><option>Krishna</option><option>Prakasam</option>
    </select>

    <div class="tabs">
      <div class="tab active" data-tab="shrimp" data-i18n="shrimp">Shrimp</div>
      <div class="tab" data-tab="ice" data-i18n="ice">Ice</div>
    </div>

    <!-- Main data table -->
    <div class="section" id="dataBox">
      <div class="head" id="thead">
        <div id="col1">Count</div>
        <div id="col2">Price</div>
      </div>
      <div id="ratesList"></div>
    </div>

    <!-- Ice: Transport calculator -->
    <div class="subttl" id="transportTitle" style="display:none" data-i18n="transport">Transport (Ice Delivery)</div>
    <div class="section" id="transportBox" style="display:none">
      <div style="padding:12px;text-align:center">
        <label>
          <span data-i18n="distance">Distance (km)</span>:
          <input type="number" id="distInput" value="10" min="0" style="width:90px;padding:8px;border:1px solid var(--border);border-radius:10px;margin-left:6px">
        </label>
      </div>
      <div class="head">
        <div id="tcol1" data-i18n="vehicle">Vehicle</div>
        <div id="tcol2" data-i18n="rentKm">Rent (₹)</div>
      </div>
      <div id="transportList"></div>
    </div>

    <footer>© <span id="yr"></span> Aquaculture A–Z Hub</footer>
  </div>

<script>
/* === language (keep your existing I18N/applyI18N/init code) === */

/* ============== CSV LOADER ============== */
const CSV_URL = 'rates.csv'; // same-folder CSV; works on GitHub Pages

// RATES structure after load:
// RATES.shrimp[district][count] = price
// RATES.ice[district][type] = price
const RATES = { shrimp: {}, ice: {} };

async function loadRatesFromCSV(){
  const res = await fetch(CSV_URL, {cache:'no-store'});
  const text = await res.text();
  for (const line of text.split(/\r?\n/)) {
    const clean = line.trim();
    if (!clean || clean.startsWith('#')) continue;
    // naive CSV split (no commas inside fields in our format)
    const parts = clean.split(',').map(s=>s.trim());
    if (parts.length < 4) continue;
    const [type, district, key, priceStr] = parts;
    const price = parseFloat(priceStr);
    if (!['shrimp','ice'].includes(type) || !district || !key || isNaN(price)) continue;
    if (!RATES[type][district]) RATES[type][district] = {};
    RATES[type][district][key] = price;
  }
}

/* ============== “Yesterday vs Today” storage ============== */
function dateKey(d){ return d.toISOString().slice(0,10); }
function todayKey(){ return dateKey(new Date()); }
function yesterdayKey(){ const d=new Date(); d.setDate(d.getDate()-1); return dateKey(d); }
function storageKey(tab, district, dayKey){ return `rates_${tab}_${district}_${dayKey}`; }

/* ============== Trend helpers (arrow near COUNT) ============== */
function trendClass(curr, prev){
  if(prev==null || isNaN(prev)) return 'flat';
  if(curr > prev) return 'up';
  if(curr < prev) return 'down';
  return 'flat';
}
function trendSpan(cls){
  if(cls==='up') return '<span class="trend up">▲</span>';
  if(cls==='down') return '<span class="trend down">▼</span>';
  return '<span class="trend flat">—</span>';
}

/* ============== Renderers (now read from CSV) ============== */
let activeTab='shrimp';

function getShrimpPrice(district, count){
  const map = RATES.shrimp[district] || {};
  return map[count]; // may be undefined if not present
}
function getIcePrice(district, type){
  const map = RATES.ice[district] || {};
  return map[type];
}

async function renderRates(){
  const district = localStorage.getItem('district') || 'Nellore';
  const list=document.getElementById('ratesList');
  list.innerHTML='';

  // ensure CSV loaded first
  if (!RATES.__loaded) {
    try { await loadRatesFromCSV(); } catch(e){ console.warn('CSV load failed', e); }
    RATES.__loaded = true;
  }

  const yKey = yesterdayKey();
  const tKey = todayKey();
  const prev = JSON.parse(localStorage.getItem(storageKey(activeTab, district, yKey)) || '{}');
  const curr = {};

  if(activeTab==='shrimp'){
    for(let c=200;c>=30;c-=10){
      // read from CSV; if missing, show "—"
      const price = getShrimpPrice(district, String(c));
      curr[c] = price ?? null;
      const cls = trendClass(price, prev[c]);
      list.innerHTML += `
        <div class="row">
          <div class="cell count">${trendSpan(cls)} ${c}c</div>
          <div class="cell price">${price!=null ? `₹ ${price}` : '—'}</div>
        </div>`;
    }
  } else {
    const items = Object.keys(RATES.ice[district]||{}); // all ice items for this district
    if(items.length===0){ items.push('Block Ice 50kg'); } // fallback label
    items.forEach(type=>{
      const price = getIcePrice(district, type);
      curr[type] = price ?? null;
      const cls = trendClass(price, prev[type]);
      list.innerHTML += `
        <div class="row">
          <div class="cell count">${trendSpan(cls)} ${type}</div>
          <div class="cell price">${price!=null ? `₹ ${price}` : '—'}</div>
        </div>`;
    });
  }

  localStorage.setItem(storageKey(activeTab, district, tKey), JSON.stringify(curr));
  applyI18N();
  renderTransport(); // your transport calculator function as before
}

/* ============== Tabs & Init (keep rest of your code) ============== */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    activeTab=tab.dataset.tab;
    renderRates();
  });
});

document.getElementById('yr').textContent=new Date().getFullYear();
const dSel=document.getElementById('districtSelect');
const saved=localStorage.getItem('district');if(saved){dSel.value=saved;document.getElementById('districtName').textContent=saved;}
dSel.addEventListener('change',e=>{localStorage.setItem('district',e.target.value);document.getElementById('districtName').textContent=e.target.value;renderRates();});

applyI18N();
renderRates();
</script>

</body>
</html>
