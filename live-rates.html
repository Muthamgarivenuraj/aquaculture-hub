<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Rates</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f6f8fb;--text:#0b1220;--muted:#5f6b85;--border:#e5e7ef;--brand:#1e66f5;--up:#0ea75a;--down:#e11d48}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial}
    .container{max-width:720px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .logo{font-weight:800;font-size:1.3rem}
    a.back{padding:8px 14px;border:1px solid var(--border);border-radius:10px;text-decoration:none;color:var(--text)}
    h2{margin:12px 0}
    select{width:100%;padding:14px;border:1px solid var(--border);border-radius:12px;font-size:1rem;font-weight:600;margin-bottom:16px}
    .tabs{display:flex;gap:10px;margin-bottom:12px}
    .tab{flex:1;text-align:center;padding:10px;border:1px solid var(--border);border-radius:12px;cursor:pointer;font-weight:600;background:#fff}
    .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

    .section{border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-top:10px;background:#fff}
    .section .head{display:grid;grid-template-columns:1fr 1fr;background:#eef3ff}
    .row{display:grid;grid-template-columns:1fr 1fr}
    .cell{padding:12px 14px;text-align:center;font-weight:600}
    .row:nth-child(odd){background:#fff}
    .row:nth-child(even){background:#f9fbff}
    .count{color:#1e66f5;display:flex;gap:8px;align-items:center;justify-content:center}
    .price{color:#059669;font-weight:800}

    .subttl{margin-top:16px;font-weight:800}
    footer{text-align:center;margin:20px 0;color:var(--muted);font-size:.85rem}

    @media(max-width:600px){
    .section .head{display:none}
    .row{grid-template-columns:1fr;border-bottom:1px solid var(--border)}
    .cell{display:flex;justify-content:space-between}
    .count{justify-content:space-between}
  }

    /* 🔄 Blink Animations for trend arrows */
    @keyframes blink-up { 0%,100% {opacity:1; transform:translateY(0);} 50% {opacity:0.3; transform:translateY(-2px);} }
    @keyframes blink-down { 0%,100% {opacity:1; transform:translateY(0);} 50% {opacity:0.3; transform:translateY(2px);} }
    .trend{display:inline-flex;gap:6px;align-items:center;justify-content:center;font-weight:700}
    .trend.up {color:var(--up); animation:blink-up 1s ease-in-out 2;}
    .trend.down {color:var(--down); animation:blink-down 1s ease-in-out 2;}
    .trend.flat {color:var(--muted);}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" data-i18n="pageLive">Live Rates</div>
      <a class="back" href="index.html" data-i18n="home">Home</a>
    </header>

    <h2 id="districtName">Nellore</h2>

    <select id="districtSelect" data-i18n-placeholder="district">
      <option>Select District</option>
      <option>Nellore</option><option>West Godavari</option>
      <option>East Godavari</option><option>Krishna</option><option>Prakasam</option>
    </select>

    <div class="tabs">
      <div class="tab active" data-tab="shrimp" data-i18n="shrimp">Shrimp</div>
      <div class="tab" data-tab="ice" data-i18n="ice">Ice</div>
    </div>

    <!-- Main data table -->
    <div class="section" id="dataBox">
      <div class="head" id="thead">
        <div id="col1">Count</div>
        <div id="col2">Price</div>
      </div>
      <div id="ratesList"></div>
    </div>

    <!-- Ice: Transport calculator -->
    <div class="subttl" id="transportTitle" style="display:none" data-i18n="transport">Transport (Ice Delivery)</div>
    <div class="section" id="transportBox" style="display:none">
      <div style="padding:12px;text-align:center">
        <label>
          <span data-i18n="distance">Distance (km)</span>:
          <input type="number" id="distInput" value="10" min="0" style="width:90px;padding:8px;border:1px solid var(--border);border-radius:10px;margin-left:6px">
        </label>
      </div>
      <div class="head">
        <div id="tcol1" data-i18n="vehicle">Vehicle</div>
        <div id="tcol2" data-i18n="rentKm">Rent (₹)</div>
      </div>
      <div id="transportList"></div>
    </div>

    <footer>© <span id="yr"></span> Aquaculture A–Z Hub</footer>
  </div>

<script>
/* === language === */
const I18N={
  en:{pageLive:"Live Rates",home:"Home",district:"Select District",
      shrimp:"Shrimp",ice:"Ice",size:"Count",rate:"Price (₹/kg)",
      type:"Type",price:"Price (₹/block)",
      transport:"Transport (Ice Delivery)",vehicle:"Vehicle",rentKm:"Rent (₹)",distance:"Distance (km)"},
  te:{pageLive:"లైవ్ రేట్స్",home:"హోమ్",district:"జిల్లా ఎంచుకోండి",
      shrimp:"రొయ్యలు",ice:"ఐస్",size:"కౌంట్",rate:"ధర (₹/కిలో)",
      type:"రకం",price:"ధర (₹/బ్లాక్)",
      transport:"రవాణా (ఐస్ డెలివరీ)",vehicle:"వాహనం",rentKm:"అద్దె (₹)",distance:"దూరం (కిమీ)"}
};
function getLang(){return localStorage.getItem('lang')||'en';}
function t(k){return (I18N[getLang()]||{})[k]||k;}
function applyI18N(){
  document.querySelectorAll('[data-i18n]').forEach(el=>el.textContent=t(el.dataset.i18n));
  document.querySelectorAll('[data-i18n-placeholder]').forEach(sel=>{
    if(sel.options.length){sel.options[0].textContent=t(sel.getAttribute('data-i18n-placeholder'));}
  });
  document.getElementById('col1').textContent=activeTab==='shrimp'?t('size'):t('type');
  document.getElementById('col2').textContent=activeTab==='shrimp'?t('rate'):t('price');
}

/* === CSV loader === */
const CSV_URL = 'rates.csv'; // keep rates.csv in same folder
const RATES = { shrimp: {}, ice: {}, __loaded:false };

async function loadRatesFromCSV(){
  const res = await fetch(CSV_URL, {cache:'no-store'});
  const text = await res.text();
  for (const line of text.split(/\r?\n/)) {
    const clean = line.trim();
    if (!clean || clean.startsWith('type,')) continue;
    const parts = clean.split(',').map(s=>s.trim());
    if (parts.length < 4) continue;
    const [type, district, key, priceStr] = parts;
    const price = parseFloat(priceStr);
    if (!['shrimp','ice'].includes(type) || !district || !key || isNaN(price)) continue;
    if (!RATES[type][district]) RATES[type][district] = {};
    RATES[type][district][key] = price;
  }
  RATES.__loaded = true;
}

/* === Date helpers for yesterday compare === */
function dateKey(d){ return d.toISOString().slice(0,10); }
function todayKey(){ return dateKey(new Date()); }
function yesterdayKey(){ const d=new Date(); d.setDate(d.getDate()-1); return dateKey(d); }
function storageKey(tab, district, dayKey){ return `rates_${tab}_${district}_${dayKey}`; }

/* === Trend: show NEXT TO COUNT, blink === */
function trendClass(curr, prev){
  if(prev==null || isNaN(prev)) return 'flat';
  if(curr > prev) return 'up';
  if(curr < prev) return 'down';
  return 'flat';
}
function trendSpan(cls){
  if(cls==='up') return '<span class="trend up">▲</span>';
  if(cls==='down') return '<span class="trend down">▼</span>';
  return '<span class="trend flat">—</span>';
}

/* === Transport: per-km rates by vehicle (capacity-based) === */
const transportVehicles = [
  {vehicle:"5 Ton Van", rate:20},  // ₹/km
  {vehicle:"8 Ton Truck", rate:30} // ₹/km
];

/* === Helpers to read prices from CSV memory === */
function getShrimpPrice(district, count){ return (RATES.shrimp[district]||{})[String(count)]; }
function getIcePrice(district, type){ return (RATES.ice[district]||{})[type]; }

/* === Renderers === */
let activeTab='shrimp';

function renderTransport(){
  const box=document.getElementById('transportBox');
  const ttl=document.getElementById('transportTitle');
  if(activeTab!=='ice'){ box.style.display='none'; ttl.style.display='none'; return; }
  ttl.style.display='block'; box.style.display='block';

  const list=document.getElementById('transportList');
  const input=document.getElementById('distInput');
  function recalc(){
    const km = Math.max(0, parseFloat(input.value) || 0);
    list.innerHTML = transportVehicles.map(v=>{
      const cost = Math.round(v.rate * km);
      return `<div class="row">
        <div class="cell">${v.vehicle} (${v.rate}₹/km)</div>
        <div class="cell">₹ ${cost}</div>
      </div>`;
    }).join('');
  }
  input.oninput = recalc;
  recalc();
}

async function renderRates(){
  const district = localStorage.getItem('district') || 'Nellore';
  document.getElementById('districtName').textContent = district;

  if (!RATES.__loaded) { try{ await loadRatesFromCSV(); }catch(e){ console.warn('CSV load failed',e); } }

  const list=document.getElementById('ratesList');
  list.innerHTML='';

  const yKey = yesterdayKey();
  const tKey = todayKey();
  const prev = JSON.parse(localStorage.getItem(storageKey(activeTab, district, yKey)) || '{}');
  const curr = {};

  if(activeTab==='shrimp'){
    for(let c=200;c>=30;c-=10){
      const price = getShrimpPrice(district, c);
      curr[c] = price ?? null;
      const cls = trendClass(price, prev[c]);
      list.innerHTML += `
        <div class="row">
          <div class="cell count">${trendSpan(cls)} ${c}c</div>
          <div class="cell price">${price!=null ? `₹ ${price}` : '—'}</div>
        </div>`;
    }
  } else {
    const items = Object.keys(RATES.ice[district]||{});
    if(items.length===0){ items.push('Block Ice 50kg'); }
    items.forEach(type=>{
      const price = getIcePrice(district, type);
      curr[type] = price ?? null;
      const cls = trendClass(price, prev[type]);
      list.innerHTML += `
        <div class="row">
          <div class="cell count">${trendSpan(cls)} ${type}</div>
          <div class="cell price">${price!=null ? `₹ ${price}` : '—'}</div>
        </div>`;
    });
  }

  // Save today's snapshot (used tomorrow)
  localStorage.setItem(storageKey(activeTab, district, tKey), JSON.stringify(curr));

  applyI18N();
  renderTransport();
}

/* === Events & Init === */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    activeTab=tab.dataset.tab;
    renderRates();
  });
});

document.getElementById('yr').textContent=new Date().getFullYear();
const dSel=document.getElementById('districtSelect');
const saved=localStorage.getItem('district'); if(saved){ dSel.value=saved; document.getElementById('districtName').textContent=saved; }
dSel.addEventListener('change',e=>{ localStorage.setItem('district',e.target.value); document.getElementById('districtName').textContent=e.target.value; renderRates(); });

applyI18N();
renderRates();
</script>
</body>
</html>
