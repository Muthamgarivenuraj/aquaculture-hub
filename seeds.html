<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Seeds ‚Ä¢ Aquaculture A‚ÄìZ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config={darkMode:'class',theme:{extend:{boxShadow:{soft:'0 12px 28px rgba(2,6,23,.08)'}}}}
  </script>
  <style>
    body{background:linear-gradient(135deg,#dbeafe 0,#e0f2fe 50%,#f0fdf4 100%)}
    .dark body{background:linear-gradient(135deg,#0f172a 0,#082f49 50%,#14532d 100%)}
    .field{border:1px solid rgb(226,232,240);border-radius:.5rem;padding:.5rem .6rem}
    .dark .field{background:#0b1220;border-color:#334155;color:#e2e8f0}
    .btn{padding:.6rem 1rem;border-radius:.75rem}
    .btn-primary{background:#059669;color:#fff}
    .btn-primary[disabled]{opacity:.5;cursor:not-allowed}
    .badge{font-size:.75rem;padding:.2rem .55rem;border-radius:.5rem}
  </style>
</head>
<body class="text-slate-900 dark:text-slate-100">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 dark:bg-slate-950/70 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="index.html" class="rounded-lg px-3 py-1.5 border border-slate-200 dark:border-slate-800">‚Üê</a>
      <h1 class="text-lg font-bold flex-1" data-i18n="seed_booking">Seed Booking</h1>
      <button id="themeToggle" class="rounded-full px-3 py-1.5 text-sm border border-slate-200 dark:border-slate-800">üåô/‚òÄÔ∏è</button>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4 space-y-6">
    <!-- Selectors -->
    <div class="rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <label class="text-sm" data-i18n="state">State
          <select id="sState" class="mt-1 field w-full"></select>
        </label>
        <label class="text-sm" data-i18n="district">District
          <select id="sDistrict" class="mt-1 field w-full"></select>
        </label>
        <label class="text-sm" data-i18n="village">Village
          <select id="sVillage" class="mt-1 field w-full"></select>
        </label>
        <label class="text-sm" data-i18n="hatchery">Hatchery
          <select id="sHatchery" class="mt-1 field w-full"></select>
        </label>
      </div>
    </div>

    <!-- Hatchery details + Booking -->
    <div id="hatchDetails" class="hidden p-4 rounded-xl border dark:border-slate-700 bg-slate-50 dark:bg-slate-800 space-y-2">
      <h2 id="hName" class="font-bold text-lg"></h2>
      <p id="hLoc" class="text-sm"></p>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
        <div><span data-i18n="next_production">Next Production</span> <div id="hProd" class="font-bold"></div></div>
        <div><span data-i18n="next_batch">Next Batch</span> <div id="hBatch" class="font-bold"></div></div>
        <div><span data-i18n="salinity">Salinity</span> <div id="hSalinity" class="font-bold"></div></div>
        <div><span data-i18n="price">Price</span> <div id="hPrice" class="font-bold"></div></div>
        <div><span data-i18n="ehp">EHP Result</span> <div id="hEhp" class="font-bold"></div></div>
      </div>
      <span id="hBonus" class="badge bg-emerald-100 text-emerald-700"></span>
      <button id="bookBtn" class="btn btn-primary" data-i18n="book">Book</button>
    </div>

    <!-- Booking Form -->
    <div id="bookingForm" class="hidden rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <label class="text-sm" data-i18n="booking_date">Booking Date
          <input id="sDate" type="date" class="mt-1 field w-full">
        </label>
        <label class="text-sm" data-i18n="production">Production
          <input id="sBatch" type="text" class="mt-1 field w-full" readonly>
        </label>
        <label class="text-sm" data-i18n="quantity">Quantity (pcs)
          <input id="sQty" type="number" value="0" class="mt-1 field w-full">
        </label>
        <label class="text-sm" data-i18n="price">Price
          <input id="sPrice" type="number" class="mt-1 field w-full" readonly>
        </label>
      </div>
      <p class="text-sm"><span data-i18n="bonus">Bonus</span>: <b id="sBonus">0%</b> | <span data-i18n="total_seeds">Total Seeds</span>: <b id="sTotal">0</b> | <span data-i18n="amount">Amount</span>: <b id="sAmount">‚Çπ 0</b></p>

      <!-- Customer Details -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <label class="text-sm" data-i18n="cust_mobile">Customer Mobile *
          <div class="mt-1 flex gap-2">
            <input id="custMobile" type="tel" placeholder="9xxxxxxxxx" class="field w-full" maxlength="10" inputmode="numeric">
            <button id="sendOtp" class="btn btn-primary whitespace-nowrap" type="button" data-i18n="send_otp">Send OTP</button>
          </div>
          <div id="otpHint" class="mt-1 text-xs text-slate-500"></div>
        </label>

        <label class="text-sm" data-i18n="enter_otp">Enter OTP
          <div class="mt-1 flex gap-2">
            <input id="otpInput" type="number" class="field w-full" placeholder="******" maxlength="6">
            <button id="verifyOtp" class="btn border border-emerald-600 text-emerald-700" type="button" data-i18n="verify">Verify</button>
          </div>
          <div id="otpStatus" class="mt-1 text-xs"></div>
        </label>

        <label class="text-sm" data-i18n="address">Address *
          <div class="mt-1 flex gap-2">
            <input id="custAddress" class="field w-full" placeholder="Village, Mandal, District">
            <button id="locBtn" class="btn border" type="button" data-i18n="use_location">Use current location</button>
          </div>
        </label>
      </div>

      <!-- Final -->
      <div class="p-3 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 flex justify-between">
        <div>üßÆ <span data-i18n="grand_total">Grand Total</span>: <b id="sGrand">‚Çπ 0</b></div>
        <button id="finalBook" class="btn btn-primary" disabled data-i18n="final_book">Finalize Booking</button>
      </div>
      <p class="text-xs text-slate-500"><span class="badge bg-amber-100 text-amber-700">Note</span> <span data-i18n="note_text">Booking requires verified mobile & address.</span></p>
    </div>
  </main>

 <script>
  // Load CSV
  async function loadCSV(path){
    try{
      const res = await fetch(path,{cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const txt = await res.text();
      return txt.trim().split("\n").slice(1).map(r=>{
        const [id,state,district,village,hatchery,salinity,price,bonus,next_production,next_batch,ehp] = r.split(",").map(s=>s.trim());
        return {state,district,village,hatchery,salinity,price:+price,bonus:+bonus,next_production,next_batch,ehp};
      });
    }catch(e){
      console.error("CSV load failed",e);
      return [];
    }
  }

  function fillDropdown(id, items){
    const lang=localStorage.getItem('lang')||'te';
    const first = (lang==='te') ? "‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø" : "Select";
    document.getElementById(id).innerHTML = `<option value="">${first}</option>` +
      items.map(v=>`<option>${v}</option>`).join("");
  }

  let hatcheries=[];

  function fillDistrict(){
    const st=sState.value;
    const ds=[...new Set(hatcheries.filter(h=>h.state===st).map(h=>h.district))];
    fillDropdown("sDistrict",ds);
    fillDropdown("sVillage",[]);
    fillDropdown("sHatchery",[]);
  }

  function fillVillage(){
    const st=sState.value, d=sDistrict.value;
    const vs=[...new Set(hatcheries.filter(h=>h.state===st && h.district===d).map(h=>h.village))];
    fillDropdown("sVillage",vs);
    fillDropdown("sHatchery",[]);
  }

  function fillHatchery(){
    const st=sState.value, d=sDistrict.value, v=sVillage.value;
    const hs=[...new Set(hatcheries.filter(h=>h.state===st && h.district===d && h.village===v).map(h=>h.hatchery))];
    fillDropdown("sHatchery",hs);
  }

  async function init(){
    hatcheries = await loadCSV("data/hatcheries.csv");
    if(!hatcheries.length){ console.warn("No hatcheries data"); return; }
    const states=[...new Set(hatcheries.map(h=>h.state))];
    fillDropdown("sState",states);
    fillDropdown("sDistrict",[]);
    fillDropdown("sVillage",[]);
    fillDropdown("sHatchery",[]);
    sState.onchange=fillDistrict;
    sDistrict.onchange=fillVillage;
    sVillage.onchange=fillHatchery;
  }

  document.addEventListener("DOMContentLoaded",()=>{
    if(!localStorage.getItem("lang")) localStorage.setItem("lang","te");
    init();
  });
</script>

</body>
</html>
