<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Seeds ‚Ä¢ Aquaculture A‚ÄìZ</title>
  <script>
    (function(){try{
      const t=localStorage.getItem('theme');
      if(t==='dark'||(!t&&matchMedia('(prefers-color-scheme: dark)').matches)){
        document.documentElement.classList.add('dark');
      }
    }catch(e){}})();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config={darkMode:'class',theme:{extend:{boxShadow:{soft:'0 12px 28px rgba(2,6,23,.08)'}}}}
  </script>
  <style>
    body{background:linear-gradient(135deg,#dbeafe 0,#e0f2fe 50%,#f0fdf4 100%)}
    .dark body{background:linear-gradient(135deg,#0f172a 0,#082f49 50%,#14532d 100%)}
    .field{border:1px solid rgb(226,232,240);border-radius:.5rem;padding:.5rem .6rem}
    .dark .field{background:#0b1220;border-color:#334155;color:#e2e8f0}
    .btn{padding:.6rem 1rem;border-radius:.75rem}
    .btn-primary{background:#059669;color:#fff}
    .btn-primary[disabled]{opacity:.5;cursor:not-allowed}
    .badge{font-size:.75rem;padding:.2rem .55rem;border-radius:.5rem}
  </style>
</head>
<body class="text-slate-900 dark:text-slate-100">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 dark:bg-slate-950/70 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="index.html" class="rounded-lg px-3 py-1.5 border border-slate-200 dark:border-slate-800">‚Üê</a>
      <h1 class="text-lg font-bold flex-1">Seed Booking</h1>
      <div class="hidden sm:flex rounded-full bg-slate-100 dark:bg-slate-900 p-1 border border-slate-200 dark:border-slate-800">
        <button id="langTE" class="px-3 py-1.5 text-sm rounded-full bg-white dark:bg-slate-800">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
        <button id="langEN" class="px-3 py-1.5 text-sm rounded-full">English</button>
      </div>
      <button id="themeToggle" class="rounded-full px-3 py-1.5 text-sm border border-slate-200 dark:border-slate-800">üåô/‚òÄÔ∏è</button>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4 space-y-6">
    <!-- Selectors -->
    <div class="rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <label class="text-sm">State
          <select id="sState" class="mt-1 field w-full"></select>
        </label>
        <label class="text-sm">District
          <select id="sDistrict" class="mt-1 field w-full"></select>
        </label>
        <label class="text-sm">Village
          <select id="sVillage" class="mt-1 field w-full"></select>
        </label>
        <label class="text-sm">Hatchery
          <select id="sHatchery" class="mt-1 field w-full"></select>
        </label>
      </div>

      <!-- Hatchery Details -->
      <div id="hatchDetails" class="hidden p-4 rounded-xl border dark:border-slate-700 bg-slate-50 dark:bg-slate-800 space-y-2">
        <h2 id="hName" class="font-bold text-lg"></h2>
        <p id="hLoc" class="text-sm"></p>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
          <div>Next Production <div id="hProd" class="font-bold"></div></div>
          <div>Next Batch <div id="hBatch" class="font-bold"></div></div>
          <div>Salinity <div id="hSalinity" class="font-bold"></div></div>
          <div>Price <div id="hPrice" class="font-bold"></div></div>
          <div>EHP Result <div id="hEhp" class="font-bold"></div></div>
        </div>
        <span id="hBonus" class="badge bg-emerald-100 text-emerald-700"></span>
        <button id="bookBtn" class="btn btn-primary">Book</button>
      </div>
    </div>

    <!-- Booking Form -->
    <div id="bookingForm" class="hidden rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <label class="text-sm">Booking Date
          <input id="sDate" type="date" class="mt-1 field w-full">
        </label>
        <label class="text-sm">Production
          <input id="sBatch" type="text" class="mt-1 field w-full" readonly>
        </label>
        <label class="text-sm">Quantity (pcs)
          <input id="sQty" type="number" value="0" class="mt-1 field w-full">
        </label>
        <label class="text-sm">Price
          <input id="sPrice" type="number" class="mt-1 field w-full" readonly>
        </label>
      </div>

      <p class="text-sm">Bonus %: <b id="sBonus">0%</b> | Total Seeds: <b id="sTotal">0</b> | Amount: <b id="sAmount">‚Çπ 0</b></p>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <label class="text-sm">Customer Mobile *
          <div class="mt-1 flex gap-2">
            <input id="custMobile" class="field w-full" maxlength="10">
            <button id="sendOtp" class="btn btn-primary">Send OTP</button>
          </div>
          <div id="otpHint" class="text-xs"></div>
        </label>
        <label class="text-sm">Enter OTP
          <div class="mt-1 flex gap-2">
            <input id="otpInput" class="field w-full">
            <button id="verifyOtp" class="btn border">Verify</button>
          </div>
          <div id="otpStatus" class="text-xs"></div>
        </label>
        <label class="text-sm">Address *
          <div class="flex gap-2">
            <input id="custAddress" class="field w-full">
            <button id="locBtn" class="btn border">Use current location</button>
          </div>
        </label>
      </div>

      <div class="p-3 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 flex justify-between">
        <div>üßÆ Grand Total: <b id="sGrand">‚Çπ 0</b></div>
        <button id="finalBook" class="btn btn-primary" disabled>Finalize Booking</button>
      </div>
    </div>
  </main>

  <script>
    let hatcheries=[];
    async function loadCSV(path){
      const res=await fetch(path);
      const txt=await res.text();
      return txt.trim().split('\n').slice(1).map(r=>{
        const [id,state,district,village,hatchery,salinity,price,bonus,next_production,next_batch,ehp]=r.split(',');
        return {state,district,village,hatchery,salinity,price:+price,bonus:+bonus,next_production,next_batch,ehp_result:ehp};
      });
    }

    async function init(){
      hatcheries=await loadCSV('data/hatcheries.csv');
      const states=[...new Set(hatcheries.map(h=>h.state))];
      const sState=document.getElementById('sState'),
            sDistrict=document.getElementById('sDistrict'),
            sVillage=document.getElementById('sVillage'),
            sHatch=document.getElementById('sHatchery');
      sState.innerHTML=states.map(s=>`<option>${s}</option>`).join('');
      sState.onchange=()=>fillDistrict();
      sDistrict.onchange=()=>fillVillage();
      sVillage.onchange=()=>fillHatch();
      sHatch.onchange=()=>showDetails();
      fillDistrict();

      document.getElementById('bookBtn').onclick=()=>{document.getElementById('bookingForm').classList.remove('hidden');updateTotals();};
      document.getElementById('sQty').oninput=updateTotals;
    }

    function fillDistrict(){
      const st=document.getElementById('sState').value;
      const ds=[...new Set(hatcheries.filter(h=>h.state===st).map(h=>h.district))];
      document.getElementById('sDistrict').innerHTML=ds.map(d=>`<option>${d}</option>`).join('');
      fillVillage();
    }
    function fillVillage(){
      const st=document.getElementById('sState').value;
      const d=document.getElementById('sDistrict').value;
      const vs=[...new Set(hatcheries.filter(h=>h.state===st && h.district===d).map(h=>h.village))];
      document.getElementById('sVillage').innerHTML=vs.map(v=>`<option>${v}</option>`).join('');
      fillHatch();
    }
    function fillHatch(){
      const st=document.getElementById('sState').value;
      const d=document.getElementById('sDistrict').value;
      const v=document.getElementById('sVillage').value;
      const hs=hatcheries.filter(h=>h.state===st && h.district===d && h.village===v);
      document.getElementById('sHatchery').innerHTML=hs.map(h=>`<option>${h.hatchery}</option>`).join('');
      showDetails();
    }
    function showDetails(){
      const st=document.getElementById('sState').value;
      const d=document.getElementById('sDistrict').value;
      const v=document.getElementById('sVillage').value;
      const h=document.getElementById('sHatchery').value;
      const x=hatcheries.find(x=>x.state===st && x.district===d && x.village===v && x.hatchery===h);
      if(!x) return;
      document.getElementById('hatchDetails').classList.remove('hidden');
      document.getElementById('hName').textContent=x.hatchery;
      document.getElementById('hLoc').textContent=`${x.district}, ${x.village}`;
      document.getElementById('hProd').textContent=x.next_production;
      document.getElementById('hBatch').textContent=x.next_batch;
      document.getElementById('hSalinity').textContent=x.salinity;
      document.getElementById('hPrice').textContent="‚Çπ "+x.price;
      document.getElementById('hEhp').textContent=x.ehp_result;
      document.getElementById('hBonus').textContent=`Bonus ‚Äî ${x.bonus}%`;
      document.getElementById('sPrice').value=x.price;
      document.getElementById('sBatch').value=x.next_batch;
      document.getElementById('sBonus').textContent=`${x.bonus}%`;
      updateTotals();
    }
    function updateTotals(){
      const qty=+document.getElementById('sQty').value||0;
      const price=+document.getElementById('sPrice').value||0;
      const bonus=parseInt(document.getElementById('sBonus').textContent)||0;
      const total=qty+Math.floor(qty*bonus/100);
      const amt=qty*price;
      document.getElementById('sTotal').textContent=total;
      document.getElementById('sAmount').textContent="‚Çπ "+amt;
      document.getElementById('sGrand').textContent="‚Çπ "+amt;
    }
    init();
  </script>
</body>
</html>
