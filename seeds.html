<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Seeds • Aquaculture A–Z</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config={darkMode:'class',theme:{extend:{boxShadow:{soft:'0 12px 28px rgba(2,6,23,.08)'}}}}
  </script>
  <style>
    body{background:linear-gradient(135deg,#dbeafe 0,#e0f2fe 50%,#f0fdf4 100%)}
    .dark body{background:linear-gradient(135deg,#0f172a 0,#082f49 50%,#14532d 100%)}
    .field{border:1px solid rgb(226,232,240);border-radius:.5rem;padding:.5rem .6rem}
    .dark .field{background:#0b1220;border-color:#334155;color:#e2e8f0}
    .btn{padding:.6rem 1rem;border-radius:.75rem}
    .btn-primary{background:#059669;color:#fff}
    .btn-primary[disabled]{opacity:.5;cursor:not-allowed}
    .badge{font-size:.75rem;padding:.2rem .55rem;border-radius:.5rem}
  </style>
</head>
<body class="text-slate-900 dark:text-slate-100">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 dark:bg-slate-950/70 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="index.html" class="rounded-lg px-3 py-1.5 border border-slate-200 dark:border-slate-800">←</a>
      <h1 class="text-lg font-bold flex-1" data-i18n="seed_title">Seed Booking</h1>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4 space-y-6">
    <!-- Selectors -->
    <div class="rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <label class="text-sm"><span data-i18n="state">State</span>
          <select id="sState" class="mt-1 field w-full"><option value="">Select</option></select>
        </label>
        <label class="text-sm ap-only"><span data-i18n="district">District</span>
          <select id="sDistrict" class="mt-1 field w-full"><option value="">Select</option></select>
        </label>
        <label class="text-sm ap-only"><span data-i18n="village">Village</span>
          <select id="sVillage" class="mt-1 field w-full"><option value="">Select</option></select>
        </label>
        <label class="text-sm"><span data-i18n="hatchery">Hatchery</span>
          <select id="sHatchery" class="mt-1 field w-full"><option value="">Select</option></select>
        </label>
      </div>

      <!-- Hatchery Details -->
      <div id="hatchDetails" class="hidden p-4 rounded-xl border dark:border-slate-700 bg-slate-50 dark:bg-slate-800 space-y-2">
        <h2 id="hName" class="font-bold text-lg"></h2>
        <p id="hLoc" class="text-sm"></p>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
          <div><span data-i18n="next_production">Next Production</span> <div id="hProd" class="font-bold"></div></div>
          <div><span data-i18n="next_batch">Next Batch</span> <div id="hBatch" class="font-bold"></div></div>
          <div><span data-i18n="salinity">Salinity</span> <div id="hSalinity" class="font-bold"></div></div>
          <div><span data-i18n="price">Price</span> <div id="hPrice" class="font-bold"></div></div>
          <div><span data-i18n="ehp_result">EHP Result</span> <div id="hEhp" class="font-bold"></div></div>
        </div>
        <span id="hBonus" class="badge bg-emerald-100 text-emerald-700"></span>
        <button id="bookBtn" class="btn btn-primary" data-i18n="book">Book</button>
      </div>
    </div>
  </main>

  <script>
    // -------- i18n dict --------
    const dict={ en:{seed_title:"Seed Booking",state:"State",district:"District",village:"Village",hatchery:"Hatchery",next_production:"Next Production",next_batch:"Next Batch",salinity:"Salinity",price:"Price",ehp_result:"EHP Result",book:"Book"}, te:{seed_title:"సీడ్ బుకింగ్",state:"రాష్ట్రం",district:"జిల్లా",village:"గ్రామం",hatchery:"హ్యాచరీ",next_production:"తరువాతి ఉత్పత్తి",next_batch:"తరువాతి బ్యాచ్",salinity:"ఉప్పుతనం",price:"ధర",ehp_result:"EHP ఫలితం",book:"బుక్"}};

    function applyI18n(){
      const lang=localStorage.getItem('lang')||'te';
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.dataset.i18n;if(dict[lang][k]) el.textContent=dict[lang][k];
      });
    }

    function getLabel(obj,key){
      const lang=localStorage.getItem("lang")||"te";
      return lang==="te"?obj[key+"_te"]:obj[key+"_en"];
    }

    let hatcheries=[];
    async function loadCSV(path){
      const res=await fetch(path);const txt=await res.text();
      return txt.trim().split('\n').slice(1).map(r=>{
        const [id,state_en,state_te,district_en,district_te,village_en,village_te,hatchery_en,hatchery_te,salinity,price,bonus,next_production,next_batch,ehp]=r.split(',');
        return {state_en,state_te,district_en,district_te,village_en,village_te,hatchery_en,hatchery_te,salinity,price:+price,bonus:+bonus,next_production,next_batch,ehp_result:ehp};
      });
    }

    function fillStates(){
      const lang=localStorage.getItem("lang")||"te";
      const states=[...new Set(hatcheries.map(h=>getLabel(h,"state")))];
      sState.innerHTML=`<option value="">${lang==="te"?"ఎంచుకోండి":"Select"}</option>`+
        states.map(st=>`<option>${st}</option>`).join('');
    }

    function fillDistrict(){
      const st=sState.value;
      const lang=localStorage.getItem("lang")||"te";

      // Reset always
      resetDropdowns(["sDistrict","sVillage","sHatchery"]);

      if(st.includes("Tamil") || st.includes("తమిళ")){
        // Hide District + Village
        document.querySelectorAll(".ap-only").forEach(el=>el.style.display="none");
        // Fill hatcheries directly
        const hs=hatcheries.filter(h=>getLabel(h,"state")===st);
        sHatchery.innerHTML=`<option value="">${lang==="te"?"ఎంచుకోండి":"Select"}</option>`+
          hs.map(h=>`<option>${getLabel(h,"hatchery")}</option>`).join('');
        return;
      }

      // Show District + Village for Andhra Pradesh
      document.querySelectorAll(".ap-only").forEach(el=>el.style.display="block");
      const ds=[...new Set(hatcheries.filter(h=>getLabel(h,"state")===st).map(h=>getLabel(h,"district")))];
      sDistrict.innerHTML='<option value="">Select</option>'+ds.map(d=>`<option>${d}</option>`).join('');
    }

    function fillVillage(){
      const st=sState.value,d=sDistrict.value;
      if(!d){resetDropdowns(['sVillage','sHatchery']);return;}
      const vs=[...new Set(hatcheries.filter(h=>getLabel(h,"state")===st&&getLabel(h,"district")===d).map(h=>getLabel(h,"village")))];
      sVillage.innerHTML='<option value="">Select</option>'+vs.map(v=>`<option>${v}</option>`).join('');
    }

    function fillHatch(){
      const st=sState.value,d=sDistrict.value,v=sVillage.value;
      const hs=hatcheries.filter(h=>getLabel(h,"state")===st&&(!d||getLabel(h,"district")===d)&&(!v||getLabel(h,"village")===v));
      sHatchery.innerHTML='<option value="">Select</option>'+hs.map(h=>`<option>${getLabel(h,"hatchery")}</option>`).join('');
    }

    function resetDropdowns(ids){ids.forEach(id=>document.getElementById(id).innerHTML='<option value="">Select</option>');}

    document.addEventListener("DOMContentLoaded",async()=>{
      if(!localStorage.getItem("lang")) localStorage.setItem("lang","te");
      applyI18n();
      hatcheries=await loadCSV('data/hatcheries.csv');
      fillStates();
      sState.onchange=fillDistrict;
      sDistrict.onchange=fillVillage;
      sVillage.onchange=fillHatch;
    });
  </script>
</body>
</html>
