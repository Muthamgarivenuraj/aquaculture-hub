<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Seeds ‚Ä¢ Aquaculture A‚ÄìZ</title>

  <!-- üåô Early theme boot -->
  <script>
    (function(){
      try{
        const t=localStorage.getItem('theme');
        if(t==='dark'||(!t && matchMedia('(prefers-color-scheme: dark)').matches)){
          document.documentElement.classList.add('dark');
        }
      }catch(e){}
    })();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config={darkMode:'class',theme:{extend:{boxShadow:{soft:'0 12px 28px rgba(2,6,23,.08)'}}}}
  </script>
  <style>
    html{scroll-behavior:smooth}
    body{background:linear-gradient(135deg,#dbeafe 0%,#e0f2fe 50%,#f0fdf4 100%)}
    .dark body{background:linear-gradient(135deg,#0f172a 0%,#082f49 50%,#14532d 100%)}
    .field{border:1px solid rgb(226,232,240);border-radius:.5rem;padding:.5rem .6rem}
    .dark .field{background:#0b1220;border-color:#334155;color:#e2e8f0}
    .btn{padding:.6rem 1rem;border-radius:.75rem}
    .btn-primary{background:#059669;color:#fff}
    .btn-primary[disabled]{opacity:.5;cursor:not-allowed}
    .badge{font-size:.75rem;padding:.2rem .55rem;border-radius:.5rem}
  </style>
</head>
<body class="text-slate-900 dark:text-slate-100">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 dark:bg-slate-950/70 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="index.html" class="rounded-lg px-3 py-1.5 border border-slate-200 dark:border-slate-800">‚Üê</a>
      <h1 class="text-lg font-bold flex-1" data-i18n="seed_title">Seed Booking</h1>
      <div class="hidden sm:flex rounded-full bg-slate-100 dark:bg-slate-900 p-1 border border-slate-200 dark:border-slate-800">
        <button id="langTE" class="px-3 py-1.5 text-sm rounded-full bg-white dark:bg-slate-800">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
        <button id="langEN" class="px-3 py-1.5 text-sm rounded-full">English</button>
      </div>
      <button id="themeToggle" class="rounded-full px-3 py-1.5 text-sm border border-slate-200 dark:border-slate-800">üåô/‚òÄÔ∏è</button>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4">
    <div class="rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border border-slate-200/60 dark:border-slate-800 space-y-5">

      <!-- Region & Hatchery selection -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <label class="text-sm">
          <span data-i18n="state">State</span>
          <select id="sState" class="mt-1 field w-full">
            <option>Andhra Pradesh</option>
            <option>Tamil Nadu</option>
          </select>
        </label>

        <label class="text-sm" id="wrapDistrict">
          <span data-i18n="district">District</span>
          <select id="sDistrict" class="mt-1 field w-full"></select>
        </label>

        <label class="text-sm" id="wrapVillage">
          <span data-i18n="village">Village</span>
          <select id="sVillage" class="mt-1 field w-full"></select>
        </label>

        <label class="text-sm">
          <span data-i18n="hatchery">Hatchery</span>
          <select id="sHatchery" class="mt-1 field w-full"></select>
        </label>
      </div>

      <!-- Hatchery details card (appears after selection) -->
      <div id="detailsCard" class="hidden rounded-xl border border-slate-200 dark:border-slate-800 p-4 bg-slate-50 dark:bg-slate-900/40">
        <div class="flex items-center justify-between">
          <div>
            <h2 id="dName" class="text-lg font-semibold">‚Äî</h2>
            <p class="text-sm opacity-80" id="dRegion">‚Äî</p>
          </div>
          <span id="dBonus" class="badge bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">Bonus ‚Äî 0%</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3 text-sm">
          <div><span class="opacity-70" data-i18n="next_prod">Next Production</span><br><b id="dProd">‚Äî</b></div>
          <div><span class="opacity-70" data-i18n="next_batch">Next Batch</span><br><b id="dBatch">‚Äî</b></div>
          <div><span class="opacity-70" data-i18n="salinity">Salinity</span><br><b id="dSalinity">‚Äî</b></div>
          <div><span class="opacity-70" data-i18n="price_per">Price/1000 (‚Çπ)</span><br><b id="dPrice">‚Äî</b></div>
        </div>
        <div class="mt-4">
          <button id="startBook" class="btn btn-primary" type="button" data-i18n="start_booking">Book</button>
        </div>
      </div>

      <!-- Booking section (hidden until Book) -->
      <div id="bookingWrap" class="hidden space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <label class="text-sm">
            <span data-i18n="booking_date">Booking Date</span>
            <input id="sDate" type="date" class="mt-1 field w-full">
          </label>

          <label class="text-sm">
            <span data-i18n="production">Production</span>
            <select id="sBatch" class="mt-1 field w-full">
              <option>Batch 1</option>
              <option>Batch 2</option>
            </select>
          </label>

          <label class="text-sm">
            <span data-i18n="qty_pcs">Quantity (pcs)</span>
            <input id="sQty" type="number" value="0" class="mt-1 field w-full" min="0">
          </label>

          <label class="text-sm">
            <span data-i18n="price_per">Price/1000 (‚Çπ)</span>
            <input id="sPrice" type="number" class="mt-1 field w-full" readonly>
          </label>
        </div>

        <p class="text-sm">
          <span data-i18n="bonus_percent">Bonus %</span>:
          <b id="sBonusPct">0%</b> |
          <span data-i18n="total_seeds">Total Seeds</span>:
          <b id="sTotalSeeds">0</b> |
          <span data-i18n="amount">Amount</span>:
          <b id="sAmount">‚Çπ 0</b>
        </p>

        <!-- Customer (OTP + Address) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <label class="text-sm">
            <span data-i18n="cust_mobile">Customer Mobile *</span>
            <div class="mt-1 flex gap-2">
              <input id="custMobile" type="tel" placeholder="9xxxxxxxxx" class="field w-full" maxlength="10" inputmode="numeric" pattern="[6-9][0-9]{9}">
              <button id="otpBtn" class="btn btn-primary whitespace-nowrap" type="button" data-mode="send" data-i18n="send_otp">Send OTP</button>
            </div>
            <div id="otpHint" class="mt-1 text-xs text-slate-500"></div>
          </label>

          <label class="text-sm">
            <span data-i18n="enter_otp">Enter OTP</span>
            <div class="mt-1 flex gap-2">
              <input id="otpInput" type="number" class="field w-full" placeholder="******" maxlength="6">
              <button id="verifyOtp" class="btn border border-emerald-600 text-emerald-700" type="button" data-i18n="verify">Verify</button>
            </div>
            <div id="otpStatus" class="mt-1 text-xs"></div>
          </label>

          <label class="text-sm">
            <span data-i18n="address">Address *</span>
            <div class="mt-1 flex gap-2">
              <input id="custAddress" class="field w-full" placeholder="Village, Mandal, District">
              <button id="locBtn" class="btn border border-slate-300 dark:border-slate-700" type="button" data-i18n="use_location">Use current location</button>
            </div>
            <div id="locStatus" class="mt-1 text-xs text-slate-500"></div>
          </label>
        </div>

        <!-- Action -->
        <div class="p-3 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="text-sm font-medium">üßÆ <span data-i18n="grand_total">Grand Total</span>:
            <b id="sGrand">‚Çπ 0</b>
          </div>
          <button id="sBook" class="btn btn-primary md:self-end" disabled data-i18n="final_book">Finalize Booking</button>
        </div>

        <p class="text-xs text-slate-500"><span class="badge bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-200">Note</span>
          <span data-i18n="note_text">Booking requires verified mobile & address.</span>
        </p>
      </div>
    </div>
  </main>

  <script>
    // ---------- i18n ----------
    const dict={
      en:{
        seed_title:"Seed Booking", state:"State", district:"District", village:"Village", hatchery:"Hatchery",
        next_prod:"Next Production", next_batch:"Next Batch", salinity:"Salinity",
        price_per:"Price/1000 (‚Çπ)", start_booking:"Book",
        production:"Production", booking_date:"Booking Date", qty_pcs:"Quantity (pcs)",
        bonus_percent:"Bonus %", total_seeds:"Total Seeds", amount:"Amount",
        cust_mobile:"Customer Mobile", send_otp:"Send OTP", resend_otp:"Resend",
        enter_otp:"Enter OTP", verify:"Verify", address:"Address",
        use_location:"Use current location", locating:"Getting location...",
        location_ok:"Location set", location_denied:"Permission denied",
        location_unavailable:"Location unavailable", location_error:"Could not fetch address",
        grand_total:"Grand Total", final_book:"Finalize Booking",
        note_text:"Booking requires verified mobile & address.",
        otp_sent:"OTP sent (demo): ", otp_invalid:"Invalid number. Enter 10 digits starting with 6‚Äì9.",
        otp_ok:"Verified ‚úì", otp_wrong:"Wrong OTP"
      },
      te:{
        seed_title:"‡∞∏‡±Ä‡∞°‡±ç‡∞∏‡±ç ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç", state:"‡∞∞‡∞æ‡∞∑‡±ç‡∞ü‡±ç‡∞∞‡∞Ç", district:"‡∞ú‡∞ø‡∞≤‡±ç‡∞≤‡∞æ", village:"‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡∞Ç", hatchery:"‡∞π‡±ç‡∞Ø‡∞æ‡∞ö‡∞∞‡±Ä",
        next_prod:"‡∞§‡∞¶‡±Å‡∞™‡∞∞‡∞ø ‡∞™‡±ç‡∞∞‡±ä‡∞°‡∞ï‡±ç‡∞∑‡∞®‡±ç", next_batch:"‡∞§‡∞¶‡±Å‡∞™‡∞∞‡∞ø ‡∞¨‡±ç‡∞Ø‡∞æ‡∞ö‡±ç", salinity:"‡∞∏‡∞æ‡∞≤‡∞ø‡∞®‡∞ø‡∞ü‡±Ä",
        price_per:"‡∞ß‡∞∞/1000 (‚Çπ)", start_booking:"‡∞¨‡±Å‡∞ï‡±ç",
        production:"‡∞™‡±ç‡∞∞‡±ä‡∞°‡∞ï‡±ç‡∞∑‡∞®‡±ç", booking_date:"‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç ‡∞§‡±á‡∞¶‡±Ä", qty_pcs:"‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç (‡∞™‡±Ä‡∞∏‡±Å‡∞≤‡±Å)",
        bonus_percent:"‡∞¨‡±ã‡∞®‡∞∏‡±ç %", total_seeds:"‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞∏‡±Ä‡∞°‡±ç‡∞∏‡±ç", amount:"‡∞Ö‡∞Æ‡±å‡∞Ç‡∞ü‡±ç",
        cust_mobile:"‡∞ï‡∞∏‡±ç‡∞ü‡∞Æ‡∞∞‡±ç ‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç", send_otp:"OTP ‡∞™‡∞Ç‡∞™‡±Å", resend_otp:"‡∞Æ‡∞≥‡±ç‡∞≤‡±Ä ‡∞™‡∞Ç‡∞™‡±Å",
        enter_otp:"OTP ‡∞é‡∞Ç‡∞ü‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞ø", verify:"‡∞µ‡±Ü‡∞∞‡∞ø‡∞´‡±à", address:"‡∞Ö‡∞°‡±ç‡∞∞‡∞∏‡±ç",
        use_location:"‡∞ï‡∞∞‡±Ü‡∞Ç‡∞ü‡±ç ‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç ‡∞µ‡∞æ‡∞°‡±Å", locating:"‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç ‡∞§‡±Ä‡∞∏‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞Ç...",
        location_ok:"‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç ‡∞∏‡±Ü‡∞ü‡±ç ‡∞Ö‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø", location_denied:"‡∞™‡∞∞‡±ç‡∞Æ‡∞ø‡∞∑‡∞®‡±ç ‡∞®‡∞ø‡∞∞‡∞æ‡∞ï‡∞∞‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø",
        location_unavailable:"‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç ‡∞¶‡±ä‡∞∞‡∞ï‡∞≤‡±á‡∞¶‡±Å", location_error:"‡∞Ö‡∞°‡±ç‡∞∞‡∞∏‡±ç ‡∞§‡±Ü‡∞ö‡±ç‡∞ö‡∞≤‡±á‡∞ï‡∞™‡±ã‡∞Ø‡∞æ‡∞Ç",
        grand_total:"‡∞ó‡±ç‡∞∞‡∞æ‡∞Ç‡∞°‡±ç ‡∞ü‡±ã‡∞ü‡∞≤‡±ç", final_book:"‡∞´‡±à‡∞®‡∞≤‡±ç ‡∞¨‡±Å‡∞ï‡±ç",
        note_text:"‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç‚Äå‡∞ï‡∞ø ‡∞µ‡±Ü‡∞∞‡∞ø‡∞´‡±à ‡∞Ö‡∞Ø‡∞ø‡∞® ‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç & ‡∞Ö‡∞°‡±ç‡∞∞‡∞∏‡±ç ‡∞Ö‡∞µ‡∞∏‡∞∞‡∞Ç.",
        otp_sent:"OTP ‡∞™‡∞Ç‡∞™‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø (‡∞°‡±Ü‡∞Æ‡±ã): ", otp_invalid:"‡∞∏‡∞∞‡±à‡∞® 10 ‡∞Ö‡∞Ç‡∞ï‡±Ü‡∞≤ ‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç ‡∞á‡∞µ‡±ç‡∞µ‡∞Ç‡∞°‡∞ø (6‚Äì9 ‡∞§‡±ã ‡∞™‡±ç‡∞∞‡∞æ‡∞∞‡∞Ç‡∞≠‡∞Ç).",
        otp_ok:"‡∞µ‡±Ü‡∞∞‡∞ø‡∞´‡±à ‡∞Ö‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø ‚úì", otp_wrong:"‡∞§‡∞™‡±ç‡∞™‡±Å OTP"
      }
    };
    function t(k){const l=localStorage.getItem('lang')||'te';return (dict[l]&&dict[l][k])||k;}
    function setLang(){const l=localStorage.getItem('lang')||'te';document.documentElement.lang=l;document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.dataset.i18n;if(dict[l][k]) el.textContent=dict[l][k];});}
    themeToggle.onclick=()=>{document.documentElement.classList.toggle('dark');localStorage.setItem('theme',document.documentElement.classList.contains('dark')?'dark':'light');};
    langEN.onclick=()=>{localStorage.setItem('lang','en');setLang();};
    langTE.onclick=()=>{localStorage.setItem('lang','te');setLang();};

    // ---------- Sample Data (expand easily) ----------
    // AP ‚Üí Districts ‚Üí Villages + Hatcheries
    // TN ‚Üí Villages + Hatcheries
    const DATA = {
      "Andhra Pradesh": {
        districts: {
          "Nellore": {
            villages: ["Kavali","Podalakur","Buchireddypalem"],
            hatcheries: [
              {name:"Blue Aqua", salinity:"15‚Äì25 ppt", price:350, bonus:20, nextProduction:"2025-09-05", nextBatch:"Batch 1"},
              {name:"CoastLine Hatchery", salinity:"18‚Äì28 ppt", price:360, bonus:30, nextProduction:"2025-09-10", nextBatch:"Batch 2"}
            ]
          },
          "Krishna": {
            villages: ["Machilipatnam","Avanigadda"],
            hatcheries: [
              {name:"Delta Hatchery", salinity:"12‚Äì22 ppt", price:370, bonus:25, nextProduction:"2025-09-08", nextBatch:"Batch 1"}
            ]
          }
        }
      },
      "Tamil Nadu": {
        villages:["Cuddalore","Nagapattinam","Pudupattinam"],
        hatcheries:[
          {name:"Chennai Aqua", salinity:"20‚Äì30 ppt", price:360, bonus:25, nextProduction:"2025-09-07", nextBatch:"Batch 1"},
          {name:"Bayfront Hatchery", salinity:"18‚Äì26 ppt", price:355, bonus:15, nextProduction:"2025-09-12", nextBatch:"Batch 2"}
        ]
      }
    };

    // ---------- Elements ----------
    const sState   = document.getElementById('sState');
    const wrapDist = document.getElementById('wrapDistrict');
    const wrapVill = document.getElementById('wrapVillage');
    const sDistrict= document.getElementById('sDistrict');
    const sVillage = document.getElementById('sVillage');
    const sHatch   = document.getElementById('sHatchery');

    const card     = document.getElementById('detailsCard');
    const dName    = document.getElementById('dName');
    const dRegion  = document.getElementById('dRegion');
    const dBonus   = document.getElementById('dBonus');
    const dProd    = document.getElementById('dProd');
    const dBatch   = document.getElementById('dBatch');
    const dSal     = document.getElementById('dSalinity');
    const dPrice   = document.getElementById('dPrice');
    const startBook= document.getElementById('startBook');

    const bookingWrap = document.getElementById('bookingWrap');
    const sDate    = document.getElementById('sDate');
    const sBatch   = document.getElementById('sBatch');
    const sQty     = document.getElementById('sQty');
    const sPrice   = document.getElementById('sPrice');
    const sBonusPct= document.getElementById('sBonusPct');
    const sTotalSeeds = document.getElementById('sTotalSeeds');
    const sAmount  = document.getElementById('sAmount');
    const sGrand   = document.getElementById('sGrand');
    const sBook    = document.getElementById('sBook');

    // OTP & Address
    const mobile   = document.getElementById('custMobile');
    const otpBtn   = document.getElementById('otpBtn');
    const otpInput = document.getElementById('otpInput');
    const verifyOtp= document.getElementById('verifyOtp');
    const otpHint  = document.getElementById('otpHint');
    const otpStatus= document.getElementById('otpStatus');
    const address  = document.getElementById('custAddress');
    const locBtn   = document.getElementById('locBtn');
    const locStatus= document.getElementById('locStatus');

    // ---------- Populate region controls ----------
    function fillState(){
      // pre-select AP
      onStateChange();
    }

    function onStateChange(){
      const st = sState.value;
      card.classList.add('hidden');
      bookingWrap.classList.add('hidden');
      sHatch.innerHTML='';
      // AP: show District + Village; TN: hide District, show Village
      if(st==="Andhra Pradesh"){
        wrapDist.style.display='';
        wrapVill.style.display='';
        const dists = Object.keys(DATA[st].districts);
        sDistrict.innerHTML = dists.map(d=>`<option>${d}</option>`).join('');
        onDistrictChange();
      }else{
        wrapDist.style.display='none';
        wrapVill.style.display='';
        const vills = DATA[st].villages;
        sVillage.innerHTML = vills.map(v=>`<option>${v}</option>`).join('');
        fillHatchList();
      }
    }

    function onDistrictChange(){
      const st=sState.value, d=sDistrict.value;
      const vills = DATA[st].districts[d].villages;
      sVillage.innerHTML = vills.map(v=>`<option>${v}</option>`).join('');
      fillHatchList();
    }

    function fillHatchList(){
      const st=sState.value;
      let hatchList=[];
      if(st==="Andhra Pradesh"){
        const d=sDistrict.value;
        hatchList = DATA[st].districts[d].hatcheries;
      }else{
        hatchList = DATA[st].hatcheries;
      }
      sHatch.innerHTML = hatchList.map((h,i)=>
        `<option value="${i}">${h.name}</option>`).join('');
      // Clear details until user picks
      card.classList.add('hidden');
      bookingWrap.classList.add('hidden');
    }

    sState.addEventListener('change', onStateChange);
    sDistrict.addEventListener('change', onDistrictChange);
    sVillage.addEventListener('change', ()=>{ /* keeps selection for context */ });
    sHatch.addEventListener('change', showDetails);

    function currentHatch(){
      const st=sState.value;
      if(st==="Andhra Pradesh"){
        const d=sDistrict.value;
        return DATA[st].districts[d].hatcheries[+sHatch.value||0];
      }else{
        return DATA[st].hatcheries[+sHatch.value||0];
      }
    }

    // ---------- Show hatchery details ----------
    function showDetails(){
      const st=sState.value;
      const reg = (st==="Andhra Pradesh") ? `${sDistrict.value}, ${sVillage.value}` : `${sVillage.value}, ${st}`;
      const h = currentHatch();
      if(!h) return;

      dName.textContent = h.name;
      dRegion.textContent = reg;
      dBonus.textContent = `Bonus ‚Äî ${h.bonus}%`;
      dProd.textContent = h.nextProduction;
      dBatch.textContent= h.nextBatch;
      dSal.textContent  = h.salinity;
      dPrice.textContent= `‚Çπ ${h.price}`;

      // Prime booking values (read-only price/bonus)
      sPrice.value = h.price;
      sBonusPct.textContent = `${h.bonus}%`;
      sQty.value = 0;
      updateTotals();

      card.classList.remove('hidden');
      bookingWrap.classList.add('hidden');
    }

    // ---------- Start booking (reveals booking form) ----------
    startBook.addEventListener('click', ()=>{
      bookingWrap.classList.remove('hidden');
      // set batch to what card shows
      const h=currentHatch();
      if(h){
        const idx = [...sBatch.options].findIndex(o=>o.text===h.nextBatch);
        if(idx>=0) sBatch.selectedIndex=idx;
      }
      document.getElementById('bookingWrap').scrollIntoView({behavior:'smooth',block:'start'});
    });

    // ---------- Totals ----------
    function updateTotals(){
      const pricePerK = +sPrice.value || 0;
      const qtyPieces = +sQty.value || 0;     // pcs
      const bonusPct  = parseInt((sBonusPct.textContent||'0').replace('%',''))||0;

      const totalSeeds = Math.floor(qtyPieces + (qtyPieces * bonusPct/100));
      const amount = Math.round((qtyPieces/1000) * pricePerK);

      sTotalSeeds.textContent = totalSeeds.toLocaleString('en-IN');
      sAmount.textContent     = `‚Çπ ${amount.toLocaleString('en-IN')}`;
      sGrand.textContent      = sAmount.textContent;

      validateForm();
    }
    sQty.addEventListener('input', updateTotals);

    // ---------- OTP flow (single button: Send ‚Üí Resend) ----------
    let currentOTP=null, otpOk=false, resendTimer=null, left=0, hasSentOnce=false;
    function validMobile(num){return /^[6-9]\d{9}$/.test(num||'');}

    function startCountdown(){
      left=30;
      otpBtn.disabled=true;
      otpBtn.textContent=`${left}s`;
      resendTimer && clearInterval(resendTimer);
      resendTimer=setInterval(()=>{
        left--; otpBtn.textContent=`${left}s`;
        if(left<=0){ clearInterval(resendTimer); otpBtn.disabled=false; otpBtn.textContent=t(hasSentOnce?'resend_otp':'send_otp'); }
      },1000);
    }

    function sendOrResendOtp(){
      if(!validMobile(mobile.value)){ otpHint.textContent=t('otp_invalid'); otpStatus.textContent=''; return; }
      currentOTP = (''+Math.floor(100000 + Math.random()*900000));
      otpOk=false; otpInput.value=''; otpStatus.textContent='';
      otpHint.innerHTML = `${t('otp_sent')} <b>${currentOTP}</b>`;
      hasSentOnce=true;
      otpBtn.dataset.mode='resend';
      otpBtn.textContent=t('resend_otp');
      startCountdown();
      validateForm();
    }
    otpBtn.addEventListener('click', sendOrResendOtp);

    verifyOtp.addEventListener('click',()=>{
      if(otpInput.value===currentOTP && currentOTP){
        otpOk=true; otpStatus.textContent=t('otp_ok'); otpStatus.className='mt-1 text-xs text-emerald-600';
      }else{
        otpOk=false; otpStatus.textContent=t('otp_wrong'); otpStatus.className='mt-1 text-xs text-rose-600';
      }
      validateForm();
    });

    // ---------- Current location for Address ----------
    async function reverseGeocode(lat, lon){
      try{
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
        if(!res.ok) throw new Error('HTTP');
        const data = await res.json();
        return data.display_name || '';
      }catch(e){ return ''; }
    }

    locBtn.addEventListener('click', async ()=>{
      locStatus.textContent = t('locating');
      locBtn.disabled = true;

      if(!('geolocation' in navigator)){
        locStatus.textContent = t('location_unavailable');
        locBtn.disabled = false; return;
      }

      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const {latitude:lat, longitude:lon} = pos.coords;
        let addr = await reverseGeocode(lat, lon);
        if(!addr) addr = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
        address.value = addr;
        locStatus.textContent = t('location_ok');
        validateForm();
        locBtn.disabled = false;
      },(err)=>{
        locStatus.textContent = (err.code===1)? t('location_denied') : t('location_unavailable');
        locBtn.disabled = false;
      },{enableHighAccuracy:true,timeout:15000,maximumAge:0});
    });

    // ---------- Validation & Book enable ----------
    function validateForm(){
      const okMobile = validMobile(mobile.value) && otpOk;
      const okAddr = (address.value||'').trim().length>0;
      sBook.disabled = !(okMobile && okAddr);
    }
    mobile.addEventListener('input',()=>{otpOk=false; otpStatus.textContent=''; validateForm();});
    address.addEventListener('input',validateForm);

    // ---------- Finalize Booking ----------
    sBook.addEventListener('click',()=>{
      if(sBook.disabled) return;
      const st=sState.value;
      const region = (st==="Andhra Pradesh") ? `${sDistrict.value}, ${sVillage.value}` : `${sVillage.value}, ${st}`;
      const h=currentHatch();

      const msg =
        `Seeds Booking\n`+
        `‚Ä¢ ${st} ‚Ä¢ ${region}\n`+
        `‚Ä¢ Hatchery: ${h.name} | Price: ‚Çπ${h.price}/1000 | Bonus: ${h.bonus}%\n`+
        `‚Ä¢ Next Production: ${h.nextProduction} | Next Batch: ${h.nextBatch} | Salinity: ${h.salinity}\n`+
        `‚Ä¢ Booking Date: ${sDate.value||'-'} | Production: ${sBatch.value}\n`+
        `‚Ä¢ Qty: ${(+(sQty.value||0)).toLocaleString('en-IN')} pcs | Total: ${sTotalSeeds.textContent}\n`+
        `‚Ä¢ Amount: ${sAmount.textContent}\n`+
        `‚Ä¢ Mobile: +91 ${mobile.value}\n`+
        `‚Ä¢ Address: ${address.value}`;
      alert('‚úÖ ' + msg);
      // WhatsApp (later):
      // window.open('https://wa.me/91XXXXXXXXXX?text='+encodeURIComponent(msg),'_blank');
    });

    // ---------- INIT ----------
    (function(){
      if(!localStorage.getItem('lang')) localStorage.setItem('lang','te');
      setLang();
      fillState();
    })();
  </script>
</body>
</html>
