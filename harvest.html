<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Harvest ‚Ä¢ Aquaculture A‚ÄìZ</title>

  <!-- üåô Early theme boot -->
  <script>
    (function(){try{
      const t=localStorage.getItem('theme');
      if(t==='dark'||(!t&&matchMedia('(prefers-color-scheme: dark)').matches)){
        document.documentElement.classList.add('dark');
      }
    }catch(e){}})();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config={darkMode:'class',theme:{extend:{boxShadow:{soft:'0 12px 28px rgba(2,6,23,.08)'}}}}
  </script>
  <style>
    html{scroll-behavior:smooth}
    body{background:linear-gradient(135deg,#dbeafe 0,#e0f2fe 50%,#f0fdf4 100%)}
    .dark body{background:linear-gradient(135deg,#0f172a 0,#082f49 50%,#14532d 100%)}
    .btn{padding:.6rem 1rem;border-radius:.75rem}
    .btn-primary{background:#059669;color:#fff}
    .btn-primary[disabled]{opacity:.5;cursor:not-allowed}
    .field{border:1px solid rgb(226,232,240);border-radius:.5rem;padding:.5rem .6rem}
    .dark .field{background:#0b1220;border-color:#334155;color:#e2e8f0}
    .badge{font-size:.75rem;padding:.15rem .5rem;border-radius:.5rem}
  </style>
</head>
<body class="text-slate-900 dark:text-slate-100">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 dark:bg-slate-950/70 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="index.html" class="rounded-lg px-3 py-1.5 border border-slate-200 dark:border-slate-800">‚Üê</a>
      <h1 class="text-lg font-bold flex-1" data-i18n="harvest_title">Harvest Booking</h1>
      <div class="hidden sm:flex rounded-full bg-slate-100 dark:bg-slate-900 p-1 border border-slate-200 dark:border-slate-800">
        <button id="langTE" class="px-3 py-1.5 text-sm rounded-full bg-white dark:bg-slate-800">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
        <button id="langEN" class="px-3 py-1.5 text-sm rounded-full">English</button>
      </div>
      <button id="themeToggle" class="rounded-full px-3 py-1.5 text-sm border border-slate-200 dark:border-slate-800">üåô/‚òÄÔ∏è</button>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4">
    <div class="rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border border-slate-200/60 dark:border-slate-800 space-y-5">

      <!-- Ice & Van rows -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <label class="text-sm">
          <span data-i18n="ice_unit">Ice unit</span>
          <select id="iceUnit" class="mt-1 field w-full">
            <option value="ton" selected>Ton(s)</option>
            <option value="can">Can(s)</option>
          </select>
        </label>

        <label class="text-sm">
          <span id="iceQtyLbl">Ice (tons)</span>
          <!-- default 0 -->
          <input id="iceQty" type="number" value="0" class="mt-1 field w-full" min="0">
        </label>

        <label class="text-sm">
          <span id="iceRateLbl">Price/ton (‚Çπ)</span>
          <!-- default 0 -->
          <input id="iceRate" type="number" value="0" class="mt-1 field w-full" min="0">
        </label>

        <div class="text-sm flex items-end">
          <div class="w-full"><span data-i18n="ice_total">Ice total</span>:
            <!-- show 0 -->
            <b id="iceTotal">‚Çπ 0</b>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <label class="text-sm">
          <span data-i18n="van_type">Van</span>
          <select id="vanType" class="mt-1 field w-full">
            <!-- default 1T -->
            <option value="1" selected>1T</option>
            <option value="2">2T</option>
            <option value="5">5T</option>
            <option value="8">8T</option>
            <option value="10">10T</option>
          </select>
        </label>

        <label class="text-sm">
          <span data-i18n="van_rate">‚Çπ/km</span>
          <!-- default 0; stays 0 until user changes van -->
          <input id="vanRate" type="number" class="mt-1 field w-full" value="0" readonly>
        </label>

        <label class="text-sm">
          <span data-i18n="van_km">Distance (km)</span>
          <!-- default 0 -->
          <input id="vanKm" type="number" value="0" class="mt-1 field w-full" min="0">
        </label>

        <div class="text-sm flex items-end">
          <div class="w-full">
            <span data-i18n="transport">Transport</span>:
            <!-- show 0 -->
            <b id="vanTotal">‚Çπ 0</b>
          </div>
        </div>
      </div>

      <!-- Customer details (mandatory) -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <label class="text-sm">
          <span data-i18n="cust_mobile">Customer Mobile *</span>
          <div class="mt-1 flex gap-2">
            <input id="custMobile" type="tel" placeholder="9xxxxxxxxx" class="field w-full" maxlength="10" inputmode="numeric" pattern="[6-9][0-9]{9}">
            <!-- Single button that becomes RESEND after first send -->
            <button id="otpBtn" class="btn btn-primary whitespace-nowrap" type="button" data-mode="send" data-i18n="send_otp">Send OTP</button>
          </div>
          <div id="otpHint" class="mt-1 text-xs text-slate-500"></div>
        </label>

        <label class="text-sm">
          <span data-i18n="enter_otp">Enter OTP</span>
          <div class="mt-1 flex gap-2">
            <input id="otpInput" type="number" class="field w-full" placeholder="******" maxlength="6">
            <button id="verifyOtp" class="btn border border-emerald-600 text-emerald-700" type="button" data-i18n="verify">Verify</button>
          </div>
          <div id="otpStatus" class="mt-1 text-xs"></div>
        </label>

        <label class="text-sm md:col-span-1">
          <span data-i18n="address">Address *</span>
          <div class="mt-1 flex gap-2">
            <input id="custAddress" class="field w-full" placeholder="Village, Mandal, District">
            <button id="locBtn" class="btn border border-slate-300 dark:border-slate-700" type="button" data-i18n="use_location">Use current location</button>
          </div>
          <div id="locStatus" class="mt-1 text-xs text-slate-500"></div>
        </label>
      </div>

      <!-- Grand total + Book -->
      <div class="p-3 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="text-sm font-medium">üßÆ <span data-i18n="grand_total">Grand Total</span>:
          <b id="grand">‚Çπ 0</b>
        </div>
        <button id="bookBtn" class="btn btn-primary md:self-end" disabled data-i18n="final_book">Finalize Booking</button>
      </div>

      <p class="text-xs text-slate-500"><span class="badge bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-200">Note</span>
        <span data-i18n="note_text">Booking requires verified mobile & address.</span>
      </p>
    </div>
  </main>

  <script>
    // ---------- i18n ----------
    const dict={
      en:{
        harvest_title:"Harvest Booking",
        ice_unit:"Ice unit", ice_total:"Ice total",
        van_type:"Van", van_rate:"‚Çπ/km", van_km:"Distance (km)", transport:"Transport",
        cust_mobile:"Customer Mobile", send_otp:"Send OTP", resend_otp:"Resend",
        enter_otp:"Enter OTP", verify:"Verify",
        address:"Address", use_location:"Use current location", locating:"Getting location...",
        location_ok:"Location set", location_denied:"Permission denied",
        location_unavailable:"Location unavailable", location_error:"Could not fetch address",
        grand_total:"Grand Total", final_book:"Finalize Booking",
        note_text:"Booking requires verified mobile & address.",
        otp_sent:"OTP sent (demo): ", otp_invalid:"Invalid number. Enter 10 digits starting with 6‚Äì9.",
        otp_ok:"Verified ‚úì", otp_wrong:"Wrong OTP", addr_required:"Address is required"
      },
      te:{
        harvest_title:"‡∞π‡∞æ‡∞∞‡±ç‡∞µ‡±Ü‡∞∏‡±ç‡∞ü‡±ç ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç",
        ice_unit:"‡∞ê‡∞∏‡±ç ‡∞Ø‡±Ç‡∞®‡∞ø‡∞ü‡±ç", ice_total:"‡∞ê‡∞∏‡±ç ‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç",
        van_type:"‡∞µ‡∞æ‡∞®‡±ç", van_rate:"‚Çπ/‡∞ï‡∞ø‡∞Æ‡±Ä", van_km:"‡∞¶‡±Ç‡∞∞‡∞Ç (‡∞ï‡∞ø‡∞Æ‡±Ä)", transport:"‡∞ü‡±ç‡∞∞‡∞æ‡∞®‡±ç‡∞∏‡±ç‚Äå‡∞™‡±ã‡∞∞‡±ç‡∞ü‡±ç",
        cust_mobile:"‡∞ï‡∞∏‡±ç‡∞ü‡∞Æ‡∞∞‡±ç ‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç", send_otp:"OTP ‡∞™‡∞Ç‡∞™‡±Å", resend_otp:"‡∞Æ‡∞≥‡±ç‡∞≤‡±Ä ‡∞™‡∞Ç‡∞™‡±Å",
        enter_otp:"OTP ‡∞é‡∞Ç‡∞ü‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞ø", verify:"‡∞µ‡±Ü‡∞∞‡∞ø‡∞´‡±à",
        address:"‡∞Ö‡∞°‡±ç‡∞∞‡∞∏‡±ç", use_location:"‡∞ï‡∞∞‡±Ü‡∞Ç‡∞ü‡±ç ‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç ‡∞µ‡∞æ‡∞°‡±Å", locating:"‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç ‡∞§‡±Ä‡∞∏‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞Ç...",
        location_ok:"‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç ‡∞∏‡±Ü‡∞ü‡±ç ‡∞Ö‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø", location_denied:"‡∞™‡∞∞‡±ç‡∞Æ‡∞ø‡∞∑‡∞®‡±ç ‡∞®‡∞ø‡∞∞‡∞æ‡∞ï‡∞∞‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø",
        location_unavailable:"‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç ‡∞¶‡±ä‡∞∞‡∞ï‡∞≤‡±á‡∞¶‡±Å", location_error:"‡∞Ö‡∞°‡±ç‡∞∞‡∞∏‡±ç ‡∞§‡±Ü‡∞ö‡±ç‡∞ö‡∞≤‡±á‡∞ï‡∞™‡±ã‡∞Ø‡∞æ‡∞Ç",
        grand_total:"‡∞ó‡±ç‡∞∞‡∞æ‡∞Ç‡∞°‡±ç ‡∞ü‡±ã‡∞ü‡∞≤‡±ç", final_book:"‡∞´‡±à‡∞®‡∞≤‡±ç ‡∞¨‡±Å‡∞ï‡±ç",
        note_text:"‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç‚Äå‡∞ï‡∞ø ‡∞µ‡±Ü‡∞∞‡∞ø‡∞´‡±à ‡∞Ö‡∞Ø‡∞ø‡∞® ‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç & ‡∞Ö‡∞°‡±ç‡∞∞‡∞∏‡±ç ‡∞Ö‡∞µ‡∞∏‡∞∞‡∞Ç.",
        otp_sent:"OTP ‡∞™‡∞Ç‡∞™‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø (‡∞°‡±Ü‡∞Æ‡±ã): ", otp_invalid:"‡∞∏‡∞∞‡±à‡∞® 10 ‡∞Ö‡∞Ç‡∞ï‡±Ü‡∞≤ ‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç ‡∞á‡∞µ‡±ç‡∞µ‡∞Ç‡∞°‡∞ø (6‚Äì9 ‡∞§‡±ã ‡∞™‡±ç‡∞∞‡∞æ‡∞∞‡∞Ç‡∞≠‡∞Ç).",
        otp_ok:"‡∞µ‡±Ü‡∞∞‡∞ø‡∞´‡±à ‡∞Ö‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø ‚úì", otp_wrong:"‡∞§‡∞™‡±ç‡∞™‡±Å OTP", addr_required:"‡∞Ö‡∞°‡±ç‡∞∞‡∞∏‡±ç ‡∞§‡∞™‡±ç‡∞™‡∞®‡∞ø‡∞∏‡∞∞‡∞ø"
      }
    };
    function t(k){const l=localStorage.getItem('lang')||'te';return (dict[l]&&dict[l][k])||k;}
    function setLang(){const l=localStorage.getItem('lang')||'te';document.documentElement.lang=l;document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.dataset.i18n; if(dict[l][k]) el.textContent=dict[l][k];});}

    // Theme & language toggles
    themeToggle.onclick=()=>{document.documentElement.classList.toggle('dark');localStorage.setItem('theme',document.documentElement.classList.contains('dark')?'dark':'light');};
    langEN.onclick=()=>{localStorage.setItem('lang','en');setLang();updateLabels();};
    langTE.onclick=()=>{localStorage.setItem('lang','te');setLang();updateLabels();};

    // ---------- Elements ----------
    const iceUnit=document.getElementById('iceUnit'),
          iceQty=document.getElementById('iceQty'),
          iceRate=document.getElementById('iceRate'),
          iceQtyLbl=document.getElementById('iceQtyLbl'),
          iceRateLbl=document.getElementById('iceRateLbl'),
          iceTotal=document.getElementById('iceTotal');

    const vanType=document.getElementById('vanType'),
          vanRate=document.getElementById('vanRate'),
          vanKm=document.getElementById('vanKm'),
          vanTotal=document.getElementById('vanTotal');

    const mobile=document.getElementById('custMobile'),
          otpBtn=document.getElementById('otpBtn'),
          otpInput=document.getElementById('otpInput'),
          verifyOtp=document.getElementById('verifyOtp'),
          otpHint=document.getElementById('otpHint'),
          otpStatus=document.getElementById('otpStatus'),
          address=document.getElementById('custAddress'),
          locBtn=document.getElementById('locBtn'),
          locStatus=document.getElementById('locStatus'),
          grand=document.getElementById('grand'),
          bookBtn=document.getElementById('bookBtn');

    // ---------- Van auto-rate map ----------
    const VAN_RATE={ '1':150,'2':200,'5':300,'8':350,'10':400 };
    function applyVanRate(){
      const v=vanType.value;
      // only set rate when user changes the dropdown
      vanRate.value=VAN_RATE[v]||0;
      calc();
    }
    // Set on user change (no initial auto-fill)
    vanType.addEventListener('change',applyVanRate);

    // ---------- Ice unit labels ----------
    function updateLabels(){
      const l=localStorage.getItem('lang')||'te';
      if(iceUnit.value==='can'){
        iceQtyLbl.textContent= l==='te'?'‡∞ê‡∞∏‡±ç (‡∞ï‡±ç‡∞Ø‡∞æ‡∞®‡±ç‡∞≤‡±Å)':'Ice (cans)';
        iceRateLbl.textContent= l==='te'?'‡∞ß‡∞∞/‡∞ï‡±ç‡∞Ø‡∞æ‡∞®‡±ç (‚Çπ)':'Price/can (‚Çπ)';
      }else{
        iceQtyLbl.textContent= l==='te'?'‡∞ê‡∞∏‡±ç (‡∞ü‡∞®‡±ç‡∞®‡±Å‡∞≤‡±Å)':'Ice (tons)';
        iceRateLbl.textContent= l==='te'?'‡∞ß‡∞∞/‡∞ü‡∞®‡±ç (‚Çπ)':'Price/ton (‚Çπ)';
      }
      calc();
    }
    iceUnit.addEventListener('change',updateLabels);

    // ---------- Totals ----------
    function calc(){
      const ice=(+iceQty.value||0)*(+iceRate.value||0);
      const van=(+vanRate.value||0)*(+vanKm.value||0);
      iceTotal.textContent=`‚Çπ ${ice.toFixed(0)}`;
      vanTotal.textContent=`‚Çπ ${van.toFixed(0)}`;
      grand.textContent=`‚Çπ ${(ice+van).toFixed(0)}`;
      validateForm();
    }
    [iceQty,iceRate,vanRate,vanKm].forEach(el=>el.addEventListener('input',calc));

    // ---------- OTP flow (single button: Send ‚Üí Resend) ----------
    let currentOTP=null, otpOk=false, resendTimer=null, left=0, hasSentOnce=false;
    function validMobile(num){return /^[6-9]\d{9}$/.test(num||'');}

    function startCountdown(){
      left=30;
      otpBtn.disabled=true;
      otpBtn.textContent=`${left}s`;
      resendTimer && clearInterval(resendTimer);
      resendTimer=setInterval(()=>{
        left--; otpBtn.textContent=`${left}s`;
        if(left<=0){ clearInterval(resendTimer); otpBtn.disabled=false; otpBtn.textContent=t(hasSentOnce?'resend_otp':'send_otp'); }
      },1000);
    }

    function sendOrResendOtp(){
      if(!validMobile(mobile.value)){ otpHint.textContent=t('otp_invalid'); otpStatus.textContent=''; return; }
      currentOTP = (''+Math.floor(100000 + Math.random()*900000));
      otpOk=false; otpInput.value=''; otpStatus.textContent='';
      otpHint.innerHTML = `${t('otp_sent')} <b>${currentOTP}</b>`;
      hasSentOnce=true;
      otpBtn.dataset.mode='resend';
      otpBtn.textContent=t('resend_otp');
      startCountdown();
      validateForm();
    }

    otpBtn.addEventListener('click', sendOrResendOtp);

    verifyOtp.addEventListener('click',()=>{
      if(otpInput.value===currentOTP && currentOTP){
        otpOk=true; otpStatus.textContent=t('otp_ok'); otpStatus.className='mt-1 text-xs text-emerald-600';
      }else{
        otpOk=false; otpStatus.textContent=t('otp_wrong'); otpStatus.className='mt-1 text-xs text-rose-600';
      }
      validateForm();
    });

    // ---------- Current location for Address ----------
    async function reverseGeocode(lat, lon){
      try{
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
        if(!res.ok) throw new Error('HTTP');
        const data = await res.json();
        return data.display_name || '';
      }catch(e){ return ''; }
    }

    locBtn.addEventListener('click', async ()=>{
      locStatus.textContent = t('locating');
      locBtn.disabled = true;

      if(!('geolocation' in navigator)){
        locStatus.textContent = t('location_unavailable');
        locBtn.disabled = false; return;
      }

      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const {latitude:lat, longitude:lon} = pos.coords;
        let addr = await reverseGeocode(lat, lon);
        if(!addr) addr = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
        address.value = addr;
        locStatus.textContent = t('location_ok');
        validateForm();
        locBtn.disabled = false;
      },(err)=>{
        locStatus.textContent = (err.code===1)? t('location_denied') : t('location_unavailable');
        locBtn.disabled = false;
      },{enableHighAccuracy:true,timeout:15000,maximumAge:0});
    });

    // ---------- Validation & Book enable ----------
    function validateForm(){
      const okMobile = validMobile(mobile.value) && otpOk;
      const okAddr = (address.value||'').trim().length>0;
      bookBtn.disabled = !(okMobile && okAddr);
    }
    address.addEventListener('input',validateForm);
    mobile.addEventListener('input',()=>{otpOk=false; otpStatus.textContent=''; validateForm();});

    // ---------- Book action ----------
    bookBtn.addEventListener('click',()=>{
      if(bookBtn.disabled) return;
      const msg =
        `Harvest Booking\n`+
        `‚Ä¢ Ice: ${iceQty.value} ${iceUnit.value==='can'?'cans':'tons'} @ ‚Çπ${iceRate.value} = ${iceTotal.textContent}\n`+
        `‚Ä¢ Van: ${vanType.value}T, ${vanKm.value}km @ ‚Çπ${vanRate.value}/km = ${vanTotal.textContent}\n`+
        `‚Ä¢ ${t('grand_total')}: ${grand.textContent}\n`+
        `‚Ä¢ Mobile: +91 ${mobile.value}\n`+
        `‚Ä¢ Address: ${address.value}`;
      alert('‚úÖ ' + msg);
      // window.open('https://wa.me/91XXXXXXXXXX?text='+encodeURIComponent(msg),'_blank');
    });

    // ---------- INIT ----------
    (function(){
      if(!localStorage.getItem('lang')) localStorage.setItem('lang','te');
      setLang();
      // NOTE: no applyVanRate() here, to keep ‚Çπ/km at 0 by default
      updateLabels();
      calc();
    })();
  </script>
</body>
</html>
