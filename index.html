<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Aquaculture A–Z • Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config={darkMode:'class',theme:{extend:{boxShadow:{soft:'0 12px 28px rgba(2,6,23,.08)'}}}}
  </script>
  <style>
    html{scroll-behavior:smooth}
    body{background:linear-gradient(135deg,#dbeafe 0%,#e0f2fe 50%,#f0fdf4 100%)}
    .dark body{background:linear-gradient(135deg,#0f172a 0%,#082f49 50%,#14532d 100%)}
    .navbtn{border:1px solid rgb(226,232,240);padding:.75rem;border-radius:.75rem;background:#fff;text-align:center;font-weight:500;font-size:0.9rem}
    .dark .navbtn{background:#0b1220;border-color:#1f2937}

    .ticker{overflow:hidden;mask-image:linear-gradient(90deg,transparent,black 8%,black 92%,transparent);-webkit-mask-image:linear-gradient(90deg,transparent,black 8%,black 92%,transparent)}
    .ticker-track{display:flex;gap:24px;white-space:nowrap;min-width:max-content;animation:ticker 20s linear infinite}
    @keyframes ticker{from{transform:translateX(0)} to{transform:translateX(-50%)}}
    @media (max-width:640px){.ticker{mask-image:none;-webkit-mask-image:none}.ticker-track{gap:16px;animation-duration:28s}}
    @keyframes blink{0%,100%{opacity:1;background-color:#facc15;color:#111827}50%{opacity:1;background-color:#dc2626;color:#fff}}
    .blink{animation:blink 1.2s infinite}

    .promo-dot{height:.5rem;width:.5rem;border-radius:9999px;border:1px solid currentColor;opacity:.5}
    .promo-dot.active{opacity:1;background:currentColor}
    .promo-slide{display:none}
    .promo-slide.active{display:block}
  </style>
</head>
<body class="text-slate-900 dark:text-slate-100">
  <!-- Header -->
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 dark:bg-slate-950/70 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-xl font-bold flex-1" data-i18n="app_title">Aquaculture A–Z</h1>
      <!-- Desktop header nav -->
      <nav class="hidden sm:flex gap-2">
        <a href="harvest.html" class="navbtn">🚚 <span data-i18n="t_harvest">Harvest</span></a>
        <a href="seeds.html" class="navbtn">🦐 <span data-i18n="t_seeds">Seeds</span></a>
        <a href="vendors.html" class="navbtn">🏪 <span data-i18n="t_dealers">Dealers</span></a>
      </nav>
      <div class="flex rounded-full bg-slate-100 dark:bg-slate-900 p-1 border border-slate-200 dark:border-slate-800">
        <button id="langTE" class="px-3 py-1.5 text-sm rounded-full bg-white dark:bg-slate-800 shadow-soft">తెలుగు</button>
        <button id="langEN" class="px-3 py-1.5 text-sm rounded-full">English</button>
      </div>
      <button id="themeToggle" class="rounded-full px-3 py-1.5 text-sm border border-slate-200 dark:border-slate-800">🌙/☀️</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 space-y-4 pb-24 sm:pb-4">
    <!-- DESKTOP-ONLY: Home | History | Shrimp -->
    <section class="hidden sm:grid grid-cols-3 gap-2">
      <a href="index.html"  class="navbtn">🏠 <span data-i18n="m_home">Home</span></a>
      <a href="harvest.html" class="navbtn">🕘 <span data-i18n="m_history">History</span></a>
      <a href="seeds.html"  class="navbtn">🦐 <span data-i18n="m_shrimp">Shrimp</span></a>
    </section>

    <!-- Flash News -->
    <section class="rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border border-slate-200/60 dark:border-slate-800">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">📰 <span data-i18n="flash_news">Flash News</span></h3>
        <span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-200">Live</span>
      </div>
      <div class="mt-3 ticker"><div id="newsTrackTop" class="ticker-track"></div></div>
      <p class="text-xs text-slate-500 mt-2"><span data-i18n="updated">Updated</span>: <span id="newsUpdatedTop">—</span></p>
    </section>

    <!-- Rates + Promotions -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Rates -->
      <div class="rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border border-slate-200/60 dark:border-slate-800">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold" data-i18n="snapshot">Live Snapshot</h3>
          <p class="text-xs text-slate-500"><span data-i18n="updated">Updated</span>: <span id="updatedAt">—</span></p>
        </div>

        <!-- Alignment strip -->
        <div class="mt-3 overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
            <tr class="text-slate-500">
              <th class="text-left py-1 pr-4 align-bottom">
                <span class="text-sm text-slate-600 dark:text-slate-300" data-i18n="lbl_type">రకం</span>
              </th>
              <th class="text-left py-1 pr-4 align-bottom">
                <div class="-ml-1 sm:-ml-2">
                  <select id="prawnType" class="text-sm border rounded-md px-2 py-1 dark:bg-slate-800 dark:border-slate-600"></select>
                </div>
              </th>
              <th class="text-left py-1 pr-4 align-bottom"></th>
            </tr>
            </thead>
          </table>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="ratesTable">
            <thead>
            <tr class="border-b dark:border-slate-800 text-slate-500">
              <th class="text-left py-2 pr-4" data-i18n="th_count">Count</th>
              <th class="text-left py-2 pr-4" data-i18n="th_price">Price (₹/kg)</th>
              <th class="text-left py-2 pr-4" data-i18n="th_change">Change</th>
            </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Promotions -->
      <div class="rounded-2xl p-4 bg-white dark:bg-slate-900 shadow-soft border border-slate-200/60 dark:border-slate-800">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">📣 <span data-i18n="promotions_title">Promotions</span></h3>
          <span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">NEW</span>
        </div>
        <div id="promoSlider" class="relative mt-3">
          <div id="promoTrack" class="overflow-hidden rounded-xl"></div>
          <div id="promoDots" class="mt-3 flex gap-2"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- MOBILE bottom nav -->
  <nav class="fixed bottom-0 inset-x-0 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 flex justify-around py-2 z-40 sm:hidden"
       style="padding-bottom: env(safe-area-inset-bottom);">
    <a href="index.html" class="flex flex-col items-center text-sm font-medium" aria-label="Home">
      <span>🏠</span><span data-i18n="m_home">Home</span>
    </a>
    <a href="harvest.html" class="flex flex-col items-center text-sm font-medium" aria-label="History">
      <span>🕘</span><span data-i18n="m_history">History</span>
    </a>
    <a href="seeds.html" class="flex flex-col items-center text-sm font-medium" aria-label="Shrimp">
      <span>🦐</span><span data-i18n="m_shrimp">Shrimp</span>
    </a>
  </nav>

  <script>
    // ---------- helpers ----------
    function $id(id){ return document.getElementById(id); }

    // CSV (optional)
    async function loadCSV(url){
      try{
        const res = await fetch(url,{cache:'no-store'});
        if(!res.ok) throw 0;
        const text = await res.text();
        const lines = text.trim().split(/\r?\n/);
        const headers = lines[0].split(',').map(s=>s.trim());
        return lines.slice(1).map(line=>{
          const c = line.split(',').map(s=>s.trim());
          const o={}; headers.forEach((h,i)=>o[h]=c[i]??''); return o;
        });
      }catch(_){ return null; }
    }

    // ---------- i18n ----------
    const dict={
      en:{app_title:"Aquaculture A–Z",t_harvest:"Harvest",t_seeds:"Seeds",t_dealers:"Dealers",
          flash_news:"Flash News",snapshot:"Live Snapshot",updated:"Updated",
          lbl_type:"Type",th_count:"Count",th_price:"Price (₹/kg)",th_change:"Change",
          promotions_title:"Promotions",chg_up:"Up",chg_down:"Down",chg_same:"No change",
          type_van:"Vannamei",type_tig:"Tiger", m_home:"Home", m_history:"History", m_shrimp:"Shrimp"},
      te:{app_title:"Aquaculture A–Z",t_harvest:"హార్వెస్ట్",t_seeds:"సీడ్స్",t_dealers:"వెండర్లు",
          flash_news:"ఫ్లాష్ న్యూస్",snapshot:"లైవ్ స్నాప్‌షాట్",updated:"అప్‌డేట్",
          lbl_type:"రకం",th_count:"కౌంట్",th_price:"ధర (₹/kg)",th_change:"మార్పు",
          promotions_title:"ప్రోమోషన్స్",chg_up:"పెరిగింది",chg_down:"తగ్గింది",chg_same:"మార్పు లేదు",
          type_van:"వన్నామీ",type_tig:"టైగర్", m_home:"హోమ్", m_history:"చరిత్ర", m_shrimp:"రొయ్యలు"}
    };
    function applyI18n(){
      const lang = localStorage.getItem('lang') || 'te';
      document.documentElement.lang = lang;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.dataset.i18n;
        if(dict[lang][k]) el.textContent = dict[lang][k];
      });
    }

    // ---------- theme ----------
    function setupTheme(){
      const btn = $id('themeToggle');
      const saved = localStorage.getItem('theme');
      if(saved==='dark' || (!saved && matchMedia('(prefers-color-scheme: dark)').matches)){
        document.documentElement.classList.add('dark');
      }
      btn.addEventListener('click',()=>{
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme',document.documentElement.classList.contains('dark')?'dark':'light');
      });
    }

    // ---------- rates ----------
    const CURRENT={Vannamei:[{c:100,p:240},{c:90,p:250},{c:80,p:260},{c:70,p:280},{c:60,p:310},{c:50,p:330},{c:40,p:350},{c:30,p:370}],
                   Tiger:[{c:50,p:330},{c:40,p:390},{c:30,p:470},{c:20,p:580}]};
    const PREVIOUS={Vannamei:[{c:100,p:235},{c:90,p:250},{c:80,p:265},{c:70,p:275},{c:60,p:300},{c:50,p:330},{c:40,p:345},{c:30,p:370}],
                    Tiger:[{c:50,p:335},{c:40,p:390},{c:30,p:460},{c:20,p:580}]};
    const idx = arr => Object.fromEntries(arr.map(x=>[x.c,x.p]));
    function withDelta(type){
      const pi = idx(PREVIOUS[type]||[]);
      return (CURRENT[type]||[]).map(r=>{
        const d = typeof pi[r.c]==='number' ? r.p - pi[r.c] : null;
        return {...r, d};
      });
    }
    function badge(d){
      const lang=localStorage.getItem('lang')||'te';
      if(d===null) return `<span class="inline-flex px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300">—</span>`;
      if(d>0) return `<span class="inline-flex gap-1 px-2 py-0.5 rounded-full text-xs bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300" title="${dict[lang].chg_up}">▲ +₹${d}</span>`;
      if(d<0) return `<span class="inline-flex gap-1 px-2 py-0.5 rounded-full text-xs bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-300" title="${dict[lang].chg_down}">▼ ₹${Math.abs(d)}</span>`;
      return `<span class="inline-flex px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300">—</span>`;
    }
    function fillTypeOptions(){
      const sel = $id('prawnType');
      if(!sel) return;
      const lang=localStorage.getItem('lang')||'te';
      const keep = sel.value || 'Vannamei';
      sel.innerHTML = `<option value="Vannamei">${dict[lang].type_van}</option>
                       <option value="Tiger">${dict[lang].type_tig}</option>`;
      sel.value = keep;
    }
    function renderRates(type){
      const body = document.querySelector('#ratesTable tbody');
      if(!body) return;
      const rows = withDelta(type);
      body.innerHTML='';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.className='border-b last:border-0 dark:border-slate-800';
        tr.innerHTML = `<td class="py-2 pr-4 font-medium">${r.c}c</td>
                        <td class="py-2 pr-4">₹ ${r.p}</td>
                        <td class="py-2 pr-4">${badge(r.d)}</td>`;
        body.appendChild(tr);
      });
      $id('updatedAt').textContent = new Intl.DateTimeFormat('en-IN',{dateStyle:'medium',timeStyle:'short'}).format(new Date());
    }

    // ---------- news ----------
    const NEWS={
      en:[{tag:'Rates',text:'50c steady across coastal AP'},{tag:'Seed',text:'Batch 1 PL open this week'},{tag:'Harvest',text:'Night DO risk; add aeration 8pm–3am'},{tag:'Market',text:'Ice ₹1200/ton in Nellore'}],
      te:[{tag:'రేట్స్',text:'50 కౌంట్ ధర స్థిరంగా ఉంది'},{tag:'సీడ్స్',text:'బ్యాచ్ 1 PL ఈ వారం ఓపెన్'},{tag:'హార్వెస్ట్',text:'రాత్రి DO రిస్క్ — 8pm–3am ఎయరేషన్ పెంచండి'},{tag:'మార్కెట్',text:'నెల్లూరు ఐస్ ₹1200/టన్'}]
    };
    function loadNews(){
      const track=$id('newsTrackTop');
      const lang=localStorage.getItem('lang')||'te';
      const items=NEWS[lang];
      const chip=(t,b=false)=>`<span class="px-2 py-0.5 rounded-full bg-sky-100 text-sky-700 dark:bg-sky-900/40 dark:text-sky-200 text-[11px] ${b?'blink':''}">${t}</span>`;
      const isHarvest=t=>String(t||'').toLowerCase().includes('harvest')||String(t).includes('హార్వెస్ట్');
      const row=items.map(n=>`<div class="flex items-center gap-2 pr-4">${chip(n.tag,isHarvest(n.tag))}<span>${n.text}</span></div>`).join('');
      track.innerHTML=row+row+row;
      $id('newsUpdatedTop').textContent=new Intl.DateTimeFormat('en-IN',{dateStyle:'medium',timeStyle:'short'}).format(new Date());
    }

    // ---------- promotions ----------
    let PROMOS=[], promoIdx=0, promoTimer=null;
    function renderPromo(){
      const track=$id('promoTrack'), dots=$id('promoDots');
      const lang=localStorage.getItem('lang')||'te';
      if(!PROMOS.length){
        PROMOS=[
          {badge:'Best Value',title_en:'5T Van — ₹22 / km',title_te:'5T వాన్ — ₹22 / కి.మీ',desc_en:'Reliable transport for harvest day.',desc_te:'హార్వెస్ట్ రోజుకు నమ్మదగిన ట్రాన్స్‌పోర్ట్.'},
          {badge:'Fresh PL',  title_en:'Seeds — Batch 1 Open',title_te:'సీడ్స్ — బ్యాచ్ 1 ఓపెన్',desc_en:'Vannamei SPF PL. Bonus up to 30%',desc_te:'వన్నామీ SPF PL. 30% బోనస్ వరకు'}
        ];
      }
      track.innerHTML = PROMOS.map((r,i)=>`
        <div class="promo-slide rounded-xl p-4 bg-blue-50 dark:bg-slate-800/40 ${i===promoIdx?'active':''}">
          ${r.badge?`<span class="inline-block text-xs px-3 py-1 rounded-full bg-sky-200/70 text-sky-900">${r.badge}</span>`:''}
          <h4 class="mt-3 text-lg font-semibold">${lang==='te'?(r.title_te||r.title_en):(r.title_en||r.title_te)}</h4>
          <p class="text-slate-600 dark:text-slate-300">${lang==='te'?(r.desc_te||r.desc_en):(r.desc_en||r.desc_te)}</p>
        </div>`).join('');
      dots.innerHTML = PROMOS.map((_,i)=>`<button class="promo-dot ${i===promoIdx?'active':''}" data-i="${i}"></button>`).join('');
      dots.querySelectorAll('button').forEach(b=>b.onclick=()=>{promoIdx=+b.dataset.i;renderPromo();startPromo();});
    }
    function startPromo(){ if(promoTimer) clearInterval(promoTimer); promoTimer=setInterval(()=>{promoIdx=(promoIdx+1)%PROMOS.length;renderPromo();},6000); }

    // ---------- init ----------
    document.addEventListener('DOMContentLoaded',async()=>{
      // language default
      if(!localStorage.getItem('lang')) localStorage.setItem('lang','te');

      // controls
      setupTheme();
      applyI18n();

      // top lang toggles
      document.getElementById('langEN').onclick=()=>{localStorage.setItem('lang','en');applyI18n();fillTypeOptions();renderRates($id('prawnType').value);loadNews();renderPromo();};
      document.getElementById('langTE').onclick=()=>{localStorage.setItem('lang','te');applyI18n();fillTypeOptions();renderRates($id('prawnType').value);loadNews();renderPromo();};

      // rates
      fillTypeOptions();
      const sel=$id('prawnType'); if(!sel.value) sel.value='Vannamei';
      sel.onchange=()=>renderRates(sel.value);
      renderRates(sel.value);

      // news
      loadNews();

      // promotions (try CSV, else fallback)
      const csv = await loadCSV('./data/promotions.csv');
      if(csv && csv.length){
        PROMOS = csv.filter(r=>(r.slot||'').toLowerCase()==='slide')
                    .sort((a,b)=>(+a.order||0)-(+b.order||0));
      }
      renderPromo(); startPromo();
    });
  </script>
</body>
</html>
